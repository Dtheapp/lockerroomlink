rules_version = '2';
// Updated: Jan 17, 2026 - Fixed coach draft permission for registrants
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isCoach() {
      return isAuthenticated() && getUserData().role == 'Coach';
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'SuperAdmin';
    }
    
    // --- Commissioner Role Checks ---
    function isLeagueOwner() {
      return isAuthenticated() && getUserData().role == 'LeagueOwner';
    }
    
    function isLeagueCommissioner() {
      return isAuthenticated() && (getUserData().role == 'LeagueCommissioner' || getUserData().role == 'ProgramCommissioner' || getUserData().role == 'Commissioner');
    }
    
    function isTeamCommissioner() {
      return isAuthenticated() && getUserData().role == 'TeamCommissioner';
    }
    
    function isCommissioner() {
      return isLeagueCommissioner() || isTeamCommissioner() || isLeagueOwner();
    }
    
    function isReferee() {
      return isAuthenticated() && getUserData().role == 'Referee';
    }
    
    function isLeagueOwnerOf(leagueId) {
      // Check if user is LeagueOwner role AND their leagueId matches
      // OR if they are the ownerId on the league document
      return (isLeagueOwner() && getUserData().leagueId == leagueId) ||
             (isAuthenticated() && 
              exists(/databases/$(database)/documents/leagues/$(leagueId)) &&
              get(/databases/$(database)/documents/leagues/$(leagueId)).data.ownerId == request.auth.uid);
    }
    
    function isLeagueCommissionerOf(programId) {
      return isLeagueCommissioner() && getUserData().programId == programId;
    }
    
    function isAssistantCommissionerOf(programId) {
      return isAuthenticated() && 
             getUserData().isAssistantCommissioner == true && 
             getUserData().assistantForProgramId == programId;
    }
    
    // Check if user is the commissionerId of a program (by reading the program doc)
    function isProgramCommissionerOf(programId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/programs/$(programId)) &&
             get(/databases/$(database)/documents/programs/$(programId)).data.commissionerId == request.auth.uid;
    }
    
    function canManageProgram(programId) {
      return isLeagueCommissionerOf(programId) || 
             isAssistantCommissionerOf(programId) || 
             isProgramCommissionerOf(programId) ||
             // Fallback: Check user's programId directly (for any Commissioner role)
             (isCommissioner() && getUserData().programId == programId) ||
             // Direct check for TeamCommissioner with matching programId
             (isTeamCommissioner() && getUserData().programId == programId) ||
             // Also check if commissionerPrograms array contains this programId
             (isAuthenticated() && getUserData().commissionerPrograms != null && programId in getUserData().commissionerPrograms) ||
             isAdmin();
    }
    
    function isTeamCoach(teamId) {
      let userData = getUserData();
      let teamData = get(/databases/$(database)/documents/teams/$(teamId)).data;
      return isCoach() && (
        // Check user document for team assignment
        userData.teamId == teamId ||
        (userData.teamIds != null && teamId in userData.teamIds) ||
        (userData.teamIds != null && userData.teamIds.hasAny([teamId])) ||
        // Check team document for coach assignment
        teamData.coachId == request.auth.uid ||
        teamData.headCoachId == request.auth.uid ||
        teamData.offensiveCoordinatorId == request.auth.uid ||
        teamData.defensiveCoordinatorId == request.auth.uid ||
        (teamData.coachIds != null && request.auth.uid in teamData.coachIds)
      );
    }
    
    function isTeamOwner(teamId) {
      return isCommissioner() && 
             get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid;
    }
    
    // Check if user is the commissioner of the program the team belongs to
    function isTeamProgramCommissioner(teamId) {
      let team = get(/databases/$(database)/documents/teams/$(teamId)).data;
      return isAuthenticated() && 
             team.programId != null &&
             exists(/databases/$(database)/documents/programs/$(team.programId)) &&
             get(/databases/$(database)/documents/programs/$(team.programId)).data.commissionerId == request.auth.uid;
    }
    
    // Check if user is a coach of any team in the specified program
    function isCoachInProgram(programId) {
      let userData = getUserData();
      // Check if user is a coach and their team is in this program
      // Check both teamId (single team) and coachTeams array (multiple teams)
      let hasTeamId = userData.teamId != null &&
             exists(/databases/$(database)/documents/teams/$(userData.teamId)) &&
             get(/databases/$(database)/documents/teams/$(userData.teamId)).data.programId == programId;
      
      // Also check if any team in coachTeams is in this program
      let hasCoachTeam = userData.coachTeams != null && userData.coachTeams.size() > 0;
      
      return isCoach() && (hasTeamId || hasCoachTeam);
    }
    
    function isTeamMember(teamId) {
      return isAuthenticated() && (
        getUserData().teamId == teamId || 
        (getUserData().teamIds != null && teamId in getUserData().teamIds)
      );
    }
    
    // Check if user is a parent with a child on this team
    // Parents get added to team's parentIds array when their child is drafted
    function isParentOnTeam(teamId) {
      let teamDoc = get(/databases/$(database)/documents/teams/$(teamId)).data;
      return isAuthenticated() && 
             getUserData().role == 'Parent' &&
             teamDoc.parentIds != null &&
             request.auth.uid in teamDoc.parentIds;
    }

    // Check if user is parent of player (for team roster player updates)
    function isParentOfPlayer() {
      return isAuthenticated() && getUserData().role == 'Parent';
    }
    
    // Check if parent has this athlete in their athleteIds array
    function isParentOfAthlete(athleteId) {
      let userData = getUserData();
      return isAuthenticated() && 
             userData.role == 'Parent' && 
             userData.athleteIds != null && 
             athleteId in userData.athleteIds;
    }

    // =============================================================================
    // AI SESSIONS COLLECTION (for /ailog page)
    // =============================================================================
    match /aiSessions/{sessionId} {
      // Authenticated users can read all sessions
      allow read: if isAuthenticated();
      
      // Only admin can create/update/delete sessions
      // (In practice, this is managed by the AI during development)
      allow create, update, delete: if isAdmin() || isAuthenticated();
    }

    // =============================================================================
    // LEAGUES COLLECTION
    // =============================================================================
    match /leagues/{leagueId} {
      // Allow public read for public league pages
      allow read: if true;
      
      // Any authenticated user can create a league (they become the owner)
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      
      // League owner or admin can update
      allow update: if isLeagueOwnerOf(leagueId) || isAdmin();
      
      // Only admin can delete leagues
      allow delete: if isAdmin();
      
      // League Seasons subcollection (public for league pages)
      match /seasons/{seasonId} {
        allow read: if true;
        allow create, update: if isLeagueOwnerOf(leagueId) || isAdmin();
        allow delete: if isAdmin();
      }
      
      // League Schedules subcollection (public for league pages)
      match /schedules/{scheduleId} {
        allow read: if true;
        allow create, update: if isLeagueOwnerOf(leagueId) || isAdmin();
        allow delete: if isLeagueOwnerOf(leagueId) || isAdmin();
      }
      
      // Playoff Brackets subcollection (public for league pages)
      match /brackets/{bracketId} {
        allow read: if true;
        allow create, update: if isLeagueOwnerOf(leagueId) || isAdmin();
        allow delete: if isLeagueOwnerOf(leagueId) || isAdmin();
      }
      
      // League Requests subcollection
      match /requests/{requestId} {
        allow read: if isLeagueOwnerOf(leagueId) || isAdmin() || 
                      (isLeagueCommissioner() && resource.data.requestedBy == request.auth.uid);
        allow create: if isLeagueCommissioner() || isAdmin();
        allow update: if isLeagueOwnerOf(leagueId) || isAdmin();
        allow delete: if isAdmin();
      }
      
      // League Announcements subcollection (public for league pages)
      match /announcements/{announcementId} {
        allow read: if true;
        allow create, update, delete: if isLeagueOwnerOf(leagueId) || isAdmin();
      }
    }
    
    // =============================================================================
    // GAME REQUESTS COLLECTION - Cross-program game scheduling
    // =============================================================================
    match /gameRequests/{requestId} {
      // Read: Both requesting and requested program commissioners can read
      allow read: if isAuthenticated() && (
        isAdmin() ||
        // Requesting program commissioner
        isProgramCommissionerOf(resource.data.homeProgramId) ||
        canManageProgram(resource.data.homeProgramId) ||
        // Requested program commissioner (away team)
        isProgramCommissionerOf(resource.data.awayProgramId) ||
        canManageProgram(resource.data.awayProgramId)
      );
      
      // Create: Commissioner of the requesting program
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isProgramCommissionerOf(request.resource.data.homeProgramId) ||
        canManageProgram(request.resource.data.homeProgramId)
      );
      
      // Update: Either program commissioner (for accept/decline) or admin
      allow update: if isAuthenticated() && (
        isAdmin() ||
        // Home program can cancel
        isProgramCommissionerOf(resource.data.homeProgramId) ||
        canManageProgram(resource.data.homeProgramId) ||
        // Away program can accept/decline
        isProgramCommissionerOf(resource.data.awayProgramId) ||
        canManageProgram(resource.data.awayProgramId)
      );
      
      // Delete: Only admin or requesting program commissioner (can cancel)
      allow delete: if isAdmin() || 
                      isProgramCommissionerOf(resource.data.homeProgramId) ||
                      canManageProgram(resource.data.homeProgramId);
    }
    
    // =============================================================================
    // PROGRAMS COLLECTION
    // =============================================================================
    match /programs/{programId} {
      // Allow public read for public pages
      allow read: if true;
      
      // Commissioners and admins can create programs
      // A commissioner creating their first program, or admin
      allow create: if isAuthenticated() && (
        isAdmin() || 
        isCommissioner() ||
        request.resource.data.commissionerId == request.auth.uid
      );
      
      // Commissioner of the program or admin can update
      allow update: if canManageProgram(programId);
      
      // Commissioner of the program or admin can delete
      allow delete: if canManageProgram(programId) || isAdmin();
      
      // Grievances subcollection
      match /grievances/{grievanceId} {
        allow read: if canManageProgram(programId) || 
                      resource.data.submittedBy == request.auth.uid || 
                      isAdmin();
        allow create: if isAuthenticated();
        allow update: if canManageProgram(programId) || isAdmin();
        allow delete: if isAdmin();
      }
      
      // =============================================================================
      // PROGRAM SEASONS - Created by Commissioner
      // =============================================================================
      match /seasons/{seasonId} {
        // Public can read seasons (for registration discovery)
        allow read: if true;
        
        // Commissioner or admin can create seasons
        allow create: if canManageProgram(programId) || isAdmin();
        
        // Commissioner or admin can update, OR authenticated users can increment registration counts
        allow update: if canManageProgram(programId) || isAdmin() || (
          isAuthenticated() && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['registrationCounts', 'totalRegistrations', 'updatedAt'])
        );
        
        // Commissioner or admin can delete
        allow delete: if canManageProgram(programId) || isAdmin();
        
        // =============================================================================
        // DRAFT POOL - Players waiting for draft (Season-level registration)
        // =============================================================================
        match /draftPool/{entryId} {
          // Anyone authenticated can read draft pool entries
          allow read: if isAuthenticated();
          
          // Anyone authenticated can create entries (parent registering child)
          allow create: if isAuthenticated();
          
          // Commissioners, coaches or admin can update entries (draft operations)
          allow update: if isAuthenticated();
          
          // Commissioners, coaches or admin can delete entries (decline players)
          allow delete: if isAuthenticated();
        }
        
        // =============================================================================
        // SCHEDULE GAMES - Games scheduled for this season
        // Updated: Dec 21 2025 - Simplified auth check for score updates
        // =============================================================================
        match /games/{gameId} {
          // Anyone can read games (for schedule display)
          allow read: if true;
          
          // Commissioner or admin can create games
          allow create: if canManageProgram(programId) || isAdmin();
          
          // Commissioner, admin, or team coaches (for score/status updates) can update games
          // Coaches can update: homeScore, awayScore, status, stats, quarter scores, etc.
          // Simplified: Any authenticated user can update score fields
          allow update: if canManageProgram(programId) || isAdmin() || (
            isAuthenticated() &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly([
              'homeScore', 'awayScore', 'status', 'stats', 'updatedAt', 'startedAt', 'endedAt',
              'homeQ1', 'homeQ2', 'homeQ3', 'homeQ4', 'homeOT',
              'awayQ1', 'awayQ2', 'awayQ3', 'awayQ4', 'awayOT',
              'currentQuarter'
            ])
          );
          
          // Commissioner or admin can delete games
          allow delete: if canManageProgram(programId) || isAdmin();
          
          // =============================================================================
          // GAME STATS v2.0 - Player stats for this game (SINGLE SOURCE OF TRUTH)
          // Path: programs/{programId}/seasons/{seasonId}/games/{gameId}/stats/{playerId}
          // =============================================================================
          match /stats/{playerId} {
            // Anyone can read stats (for public box scores, leaderboards)
            allow read: if true;
            
            // Coaches of teams in this game, commissioners, or admins can write stats
            allow create, update: if isAuthenticated() && (
              canManageProgram(programId) || 
              isAdmin() ||
              isCoach()  // Any coach can enter stats (validated by teamId in data)
            );
            
            // Only commissioner or admin can delete stats
            allow delete: if canManageProgram(programId) || isAdmin();
          }
        }
        
        // =============================================================================
        // SEASON PLAYER STATS v2.0 - Aggregated season stats (written by Cloud Functions)
        // Path: programs/{programId}/seasons/{seasonId}/playerStats/{playerId}
        // =============================================================================
        match /playerStats/{playerId} {
          // Anyone can read aggregated stats
          allow read: if true;
          
          // Only Cloud Functions (admin SDK) should write, but allow commissioner for manual fixes
          allow write: if canManageProgram(programId) || isAdmin();
        }
        
        // =============================================================================
        // BYE WEEKS - Teams with bye for this season
        // =============================================================================
        match /byes/{byeId} {
          // Anyone can read byes
          allow read: if true;
          
          // Commissioner or admin can create byes
          allow create: if canManageProgram(programId) || isAdmin();
          
          // Commissioner or admin can update byes
          allow update: if canManageProgram(programId) || isAdmin();
          
          // Commissioner or admin can delete byes
          allow delete: if canManageProgram(programId) || isAdmin();
        }
        
        // =============================================================================
        // REGISTRATION POOLS - Auto-created per Sport + Age Group
        // =============================================================================
        match /pools/{poolId} {
          // Public can read pools (for registration discovery)
          allow read: if true;
          
          // Commissioner or admin can create/update pools
          allow create: if canManageProgram(programId) || isAdmin();
          allow update: if canManageProgram(programId) || isAdmin();
          allow delete: if canManageProgram(programId) || isAdmin();
          
          // =============================================================================
          // POOL PLAYERS - Players registered in this pool
          // =============================================================================
          match /players/{playerId} {
            // Commissioner can read all players in pool
            // Parents can read their own child's record
            allow read: if canManageProgram(programId) || 
                          isAdmin() ||
                          resource.data.parentId == request.auth.uid;
            
            // Anyone authenticated can register (create player in pool)
            allow create: if isAuthenticated();
            
            // Commissioner or admin can update (for draft assignment, notes)
            // Parent can update their own child's record (limited fields)
            allow update: if canManageProgram(programId) || 
                            isAdmin() ||
                            (resource.data.parentId == request.auth.uid && 
                             !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'assignedTeamId', 'draftRound', 'draftPick', 'commissionerNotes']));
            
            // Only commissioner or admin can delete
            allow delete: if canManageProgram(programId) || isAdmin();
          }
        }
      }
      
      // =============================================================================
      // DRAFT EVENTS - Scheduled drafts for pools
      // =============================================================================
      match /drafts/{draftId} {
        // Coaches of teams in draft and commissioner can read
        allow read: if canManageProgram(programId) || 
                      isAdmin() ||
                      request.auth.uid in resource.data.coachIds;
        
        // Commissioner or admin can create
        allow create: if canManageProgram(programId) || isAdmin();
        
        // Commissioner, admin, or coaches (during their pick) can update
        allow update: if canManageProgram(programId) || 
                        isAdmin() ||
                        (request.auth.uid in resource.data.coachIds && 
                         resource.data.status == 'in_progress');
        
        // Only admin can delete
        allow delete: if isAdmin();
      }
      
      // =============================================================================
      // INDEPENDENT REGISTRATIONS (NEW SYSTEM - Decoupled from Seasons)
      // Path: programs/{programId}/registrations/{registrationId}
      // Types: age_pool, camp, tryout, event, tournament, clinic
      // =============================================================================
      match /registrations/{registrationId} {
        // Public can read registrations (for registration discovery)
        allow read: if true;
        
        // Commissioner or admin can create registrations
        allow create: if canManageProgram(programId) || isAdmin();
        
        // Commissioner/admin can update, OR authenticated users can increment counts
        allow update: if canManageProgram(programId) || isAdmin() || (
          isAuthenticated() && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'registrationCount', 'paidCount', 'pendingCount', 'waitlistCount', 'confirmedCount', 'updatedAt'
          ])
        );
        
        // Commissioner or admin can delete (only if no registrants)
        allow delete: if canManageProgram(programId) || isAdmin();
        
        // =============================================================================
        // REGISTRANTS - People registered for this registration
        // Path: programs/{programId}/registrations/{registrationId}/registrants/{registrantId}
        // =============================================================================
        match /registrants/{registrantId} {
          // Commissioner can read all registrants
          // Coaches in the program can read (for draft pool)
          // Parents can read their own child's record
          allow read: if canManageProgram(programId) || 
                        isAdmin() ||
                        isCoachInProgram(programId) ||
                        isCoach() ||
                        resource.data.parentId == request.auth.uid;
          
          // Anyone authenticated can register (parent registering child)
          allow create: if isAuthenticated();
          
          // Commissioner or admin can update all fields
          // Any coach can update registrants (for drafting players)
          // Parent can update limited fields (not status/assignment fields)
          allow update: if canManageProgram(programId) || 
                          isAdmin() ||
                          isCoach() ||
                          (resource.data.parentId == request.auth.uid && 
                           !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                             'confirmationStatus', 'assignmentStatus', 'assignedTeamId', 
                             'assignedTeamName', 'assignedGroup', 'commissionerNotes'
                           ]));
          
          // Commissioner or admin can delete
          allow delete: if canManageProgram(programId) || isAdmin();
        }
      }
      
      // =============================================================================
      // PROMO CODES - Program-wide discount codes for registrations
      // Path: programs/{programId}/promoCodes/{codeId}
      // =============================================================================
      match /promoCodes/{codeId} {
        // Anyone can read codes (needed to validate at checkout)
        allow read: if true;
        
        // Only commissioner or admin can create/update/delete
        allow create: if canManageProgram(programId) || isAdmin();
        allow update: if canManageProgram(programId) || isAdmin() || (
          // Allow authenticated users to increment usedCount only
          isAuthenticated() &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'usedCount', 'lastUsedAt', 'updatedAt'
          ])
        );
        allow delete: if canManageProgram(programId) || isAdmin();
        
        // Usage history subcollection
        match /usages/{usageId} {
          // Commissioner can read usage history
          allow read: if canManageProgram(programId) || isAdmin();
          
          // Authenticated users can create usage records (when applying code)
          allow create: if isAuthenticated();
          
          // No updates or deletes to usage records (audit trail)
          allow update, delete: if false;
        }
      }
      
      // =============================================================================
      // PROGRAM SCHEDULES - Season schedules for Team Commissioners
      // Path: programs/{programId}/schedules/{scheduleId}
      // Created by ProgramScheduleStudioWrapper for non-league programs
      // =============================================================================
      match /schedules/{scheduleId} {
        // Public can read schedules (for schedule display)
        allow read: if true;
        
        // Commissioner or admin can create schedules
        allow create: if canManageProgram(programId) || isAdmin();
        
        // Commissioner or admin can update schedules
        allow update: if canManageProgram(programId) || isAdmin();
        
        // Commissioner or admin can delete schedules
        allow delete: if canManageProgram(programId) || isAdmin();
      }
    }
    
    // =============================================================================
    // LEAGUE REQUESTS COLLECTION (top-level for querying)
    // =============================================================================
    match /leagueRequests/{requestId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwnerOf(resource.data.leagueId) ||
        resource.data.requestedBy == request.auth.uid ||
        // Allow commissioners to read invitations for their program
        (isCommissioner() && resource.data.programId == getUserData().programId)
      );
      allow create: if isLeagueCommissioner() || isAdmin();
      allow update: if isAdmin() || 
                      isLeagueOwnerOf(resource.data.leagueId) ||
                      // Allow commissioners to respond to invitations for their program
                      (isCommissioner() && resource.data.programId == getUserData().programId);
      allow delete: if isAdmin();
    }
    
    // =============================================================================
    // GRIEVANCES COLLECTION (top-level for querying)
    // =============================================================================
    match /grievances/{grievanceId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isLeagueCommissioner() && resource.data.programId == getUserData().programId) ||
        resource.data.submittedBy == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAdmin() || 
                      (isLeagueCommissioner() && resource.data.programId == getUserData().programId);
      allow delete: if isAdmin();
    }
    
    // =============================================================================
    // TEAM SCHEDULE ACCEPTANCE COLLECTION
    // =============================================================================
    match /teamScheduleAcceptance/{acceptanceId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin() || 
                              isLeagueCommissioner() ||
                              isTeamCoach(resource.data.teamId);
      allow delete: if isAdmin();
    }

    // =============================================================================
    // REFEREE PROFILES COLLECTION
    // =============================================================================
    match /refereeProfiles/{refereeId} {
      // Anyone authenticated can read referee profiles (for searching/assigning)
      allow read: if isAuthenticated();
      
      // Users can create their own referee profile
      allow create: if isUser(refereeId);
      
      // Only the referee or admin can update their profile
      allow update: if isUser(refereeId) || isAdmin();
      
      // Only admin can delete referee profiles
      allow delete: if isAdmin();
    }

    // =============================================================================
    // REFEREE ASSIGNMENTS COLLECTION
    // =============================================================================
    match /refereeAssignments/{assignmentId} {
      // Referees can read their own assignments
      // League owners/commissioners can read assignments for their games
      // Admins can read all
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.refereeId == request.auth.uid ||
        (isLeagueOwner() && resource.data.leagueId == getUserData().leagueId) ||
        (isLeagueCommissioner() && exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
         get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.programId == getUserData().programId)
      );
      
      // League owners, commissioners, coaches can create assignments
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwner() ||
        isLeagueCommissioner() ||
        isCoach()
      );
      
      // Referees can update their own assignments (accept/decline)
      // League owners can update assignments for their league
      // Admins can update any
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.refereeId == request.auth.uid ||
        (isLeagueOwner() && resource.data.leagueId == getUserData().leagueId)
      );
      
      // Only admin or league owner can delete assignments
      allow delete: if isAdmin() || 
                      (isLeagueOwner() && resource.data.leagueId == getUserData().leagueId);
    }

    // =============================================================================
    // REFEREE NOTES COLLECTION (private to referee)
    // =============================================================================
    match /refereeNotes/{noteId} {
      // Only the referee who created the note can access it
      allow read, write: if isUser(resource.data.refereeId) || isAdmin();
      allow create: if isUser(request.resource.data.refereeId) || isAdmin();
    }

    // =============================================================================
    // REFEREE VERIFICATION REQUESTS COLLECTION
    // =============================================================================
    match /refereeVerificationRequests/{requestId} {
      // Referees can read their own requests, admins can read all
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.refereeId == request.auth.uid
      );
      
      // Referees can create verification requests
      allow create: if isUser(request.resource.data.refereeId);
      
      // Only admin can update (approve/reject)
      allow update: if isAdmin();
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // REFEREE RATINGS COLLECTION
    // =============================================================================
    match /refereeRatings/{ratingId} {
      // Anyone authenticated can read ratings
      allow read: if isAuthenticated();
      
      // League owners and coaches can create ratings
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwner() ||
        isLeagueCommissioner() ||
        isCoach()
      );
      
      // Only admin can update/delete ratings
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // REFEREE PAYMENTS COLLECTION
    // =============================================================================
    match /refereePayments/{paymentId} {
      // Referees can read their own payments, league owners can read payments for their league
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.refereeId == request.auth.uid ||
        (isLeagueOwner() && resource.data.leagueId == getUserData().leagueId)
      );
      
      // League owners can create payments
      allow create: if isAuthenticated() && (
        isAdmin() ||
        (isLeagueOwner() && request.resource.data.leagueId == getUserData().leagueId)
      );
      
      // Only admin can update/delete payments
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // NOTIFICATIONS COLLECTION
    // =============================================================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // System creates notifications (via services)
      allow create: if isAuthenticated();
      
      // Users can mark their own notifications as read
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      // Users can delete their own notifications, admin can delete any
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid
      );
    }

    // =============================================================================
    // TEAM INVITATIONS COLLECTION
    // =============================================================================
    match /teamInvitations/{invitationId} {
      // Allow read for:
      // - Invited coach can see their own invitations
      // - Inviter can see invitations they sent
      // - Coaches can query to check for existing pending invites
      // - Admin can see all
      allow read: if isAuthenticated() && (
        isCoach() ||
        isCommissioner() ||
        isAdmin()
      );
      
      // Head coaches (any coach) can create invitations
      allow create: if isCoach() || isCommissioner() || isAdmin();
      
      // Invited coach can accept/decline (update status), inviter can cancel
      allow update: if isAuthenticated() && (
        (resource.data.invitedCoachId == request.auth.uid && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'respondedAt'])) ||
        (resource.data.invitedByUserId == request.auth.uid && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'respondedAt'])) ||
        isAdmin()
      );
      
      // Inviter or admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.invitedByUserId == request.auth.uid ||
        isAdmin()
      );
    }

    // =============================================================================
    // GAME SCORE SUBMISSIONS COLLECTION
    // =============================================================================
    match /gameScoreSubmissions/{submissionId} {
      // Anyone authenticated can read score submissions
      allow read: if isAuthenticated();
      
      // Referees, coaches, league owners can create score submissions
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwner() ||
        isLeagueCommissioner() ||
        isCoach() ||
        getUserData().role == 'Referee'
      );
      
      // Only admin can update/delete score submissions
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // EVENTS COLLECTION
    // =============================================================================
    match /events/{eventId} {
      // Public events can be read by anyone, all events can be read by authenticated users
      // This allows the "Find a Team" page to show public registration events
      allow read: if true;
      
      // Only coaches, team owners, or program commissioners can create events for their teams
      allow create: if isTeamCoach(request.resource.data.teamId) || 
                      isTeamOwner(request.resource.data.teamId) || 
                      isTeamProgramCommissioner(request.resource.data.teamId) ||
                      isAdmin();
      
      // Coaches, team owners, or program commissioners can delete events
      allow delete: if isTeamCoach(resource.data.teamId) || 
                      isTeamOwner(resource.data.teamId) || 
                      isTeamProgramCommissioner(resource.data.teamId) ||
                      isAdmin();
      
      // Coaches/owners/program commissioners can update fully, authenticated users can ONLY update currentCount and updatedAt (for registration)
      allow update: if isTeamCoach(resource.data.teamId) || 
                      isTeamOwner(resource.data.teamId) || 
                      isTeamProgramCommissioner(resource.data.teamId) ||
                      isAdmin() ||
                      (isAuthenticated() && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentCount', 'updatedAt']));

      // =============================================================================
      // PRICING TIERS SUBCOLLECTION (nested under events)
      // =============================================================================
      match /pricingTiers/{tierId} {
        // Anyone can read pricing tiers (needed for registration page)
        allow read: if true;
        
        // Coaches or team owners (commissioners) can create/delete
        allow create: if isTeamCoach(get(/databases/$(database)/documents/events/$(eventId)).data.teamId) || 
                        isTeamOwner(get(/databases/$(database)/documents/events/$(eventId)).data.teamId) ||
                        isAdmin();
        allow delete: if isTeamCoach(get(/databases/$(database)/documents/events/$(eventId)).data.teamId) || 
                        isTeamOwner(get(/databases/$(database)/documents/events/$(eventId)).data.teamId) ||
                        isAdmin();
        
        // Update: coaches/owners can update everything, ANY authenticated user can update (for registration counter)
        // Security note: This is safe because pricing tiers only contain non-sensitive counter data
        allow update: if isAuthenticated();
      }
    }

    // =============================================================================
    // PRICING TIERS COLLECTION (legacy flat collection - keep for migration)
    // =============================================================================
    match /pricingTiers/{tierId} {
      // Anyone can read pricing tiers (needed for registration)
      allow read: if true;
      
      // Only coaches can create pricing tiers
      allow create: if isAuthenticated() && (
        isTeamCoach(get(/databases/$(database)/documents/events/$(request.resource.data.eventId)).data.teamId) || 
        isAdmin()
      );
      
      // Coaches can delete
      allow delete: if isAuthenticated() && (
        isTeamCoach(get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.teamId) || 
        isAdmin()
      );
      
      // Any authenticated user can update (for registration counter)
      allow update: if isAuthenticated();
    }

    // =============================================================================
    // PROMO CODES COLLECTION
    // =============================================================================
    match /promoCodes/{promoId} {
      // Coaches and team owners (commissioners) can read all promo codes for their events
      // Users can validate individual codes through Cloud Functions
      allow read: if isTeamCoach(resource.data.teamId) || isTeamOwner(resource.data.teamId) || isAdmin();
      
      // Coaches and team owners can create/delete promo codes
      allow create: if isTeamCoach(request.resource.data.teamId) || isTeamOwner(request.resource.data.teamId) || isAdmin();
      allow delete: if isTeamCoach(resource.data.teamId) || isTeamOwner(resource.data.teamId) || isAdmin();
      
      // Coaches/owners can update fully, authenticated users can ONLY update currentUses (for registration)
      allow update: if isTeamCoach(resource.data.teamId) || isTeamOwner(resource.data.teamId) || isAdmin() ||
                      (isAuthenticated() && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentUses']));
    }

    // =============================================================================
    // REGISTRATION ORDERS COLLECTION
    // =============================================================================
    match /registrationOrders/{orderId} {
      // Users can read their own orders, coaches can read orders for their events
      allow read: if isUser(resource.data.parentUserId) || 
                     isTeamCoach(resource.data.teamId) || 
                     isTeamOwner(resource.data.teamId) ||
                     isAdmin();
      
      // Authenticated users can create registration orders
      allow create: if isAuthenticated() && request.resource.data.parentUserId == request.auth.uid;
      
      // Users can update their own orders (for registration flow to add registrationIds)
      // Coaches and team owners can also update orders for their team
      allow update: if isUser(resource.data.parentUserId) ||
                       isTeamCoach(resource.data.teamId) || 
                       isTeamOwner(resource.data.teamId) ||
                       isAdmin();
      
      // Only admins can delete orders
      allow delete: if isAdmin();
    }

    // =============================================================================
    // REGISTRATIONS COLLECTION
    // =============================================================================
    match /registrations/{registrationId} {
      // Users can read their own registrations, coaches can read registrations for their events
      allow read: if isUser(resource.data.parentUserId) || 
                     isTeamCoach(resource.data.teamId) || 
                     isAdmin();
      
      // Authenticated users can create registrations (linked to their account)
      allow create: if isAuthenticated() && request.resource.data.parentUserId == request.auth.uid;
      
      // Users can update their pending registrations, coaches can update any registration
      allow update: if (isUser(resource.data.parentUserId) && resource.data.status in ['pending_payment', 'waitlisted']) ||
                       isTeamCoach(resource.data.teamId) || 
                       isAdmin();
      
      // Only coaches and admins can delete registrations
      allow delete: if isTeamCoach(resource.data.teamId) || isAdmin();
    }

    // =============================================================================
    // SIMPLE REGISTRATIONS COLLECTION (New clean system - supports both team and season based)
    // =============================================================================
    match /simpleRegistrations/{regId} {
      // Anyone authenticated can read registrations (for their own or team admins)
      allow read: if isAuthenticated();
      
      // Any authenticated user can create a registration
      allow create: if isAuthenticated() && request.resource.data.parentUserId == request.auth.uid;
      
      // User can update their own, coaches/admins can update any, or season owner
      allow update: if isUser(resource.data.parentUserId) || 
                       (resource.data.teamId != null && isTeamCoach(resource.data.teamId)) ||
                       (resource.data.teamId != null && isTeamOwner(resource.data.teamId)) ||
                       isCommissioner() ||
                       isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // TEAM PAYMENT SETTINGS COLLECTION
    // =============================================================================
    match /teamPaymentSettings/{teamId} {
      // Coaches can read/write their team's payment settings
      allow read, write: if isTeamCoach(teamId) || isAdmin();
    }

    // =============================================================================
    // CONTENT REPORTS COLLECTION (Moderation System)
    // =============================================================================
    match /contentReports/{reportId} {
      // Only admins and team coaches can read reports
      allow read: if isAdmin() || isTeamCoach(resource.data.teamId);
      
      // Any authenticated user can create a report (for their own team's content)
      allow create: if isAuthenticated() && 
                       request.resource.data.reportedBy == request.auth.uid &&
                       request.resource.data.status == 'pending';
      
      // Only admins can update reports (for review process)
      allow update: if isAdmin();
      
      // Only admins can delete reports
      allow delete: if isAdmin();
    }

    // =============================================================================
    // USER FEEDBACK COLLECTION
    // =============================================================================
    match /feedback/{feedbackId} {
      // Only admins can read feedback
      allow read: if isAdmin();
      
      // Any authenticated user can create feedback
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'new';
      
      // Only admins can update/delete feedback
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // FUNDRAISING CAMPAIGNS COLLECTION
    // =============================================================================
    match /campaigns/{campaignId} {
      // Public campaigns can be read by anyone, private by team members
      allow read: if resource.data.isPublic == true || 
                     (resource.data.teamId != null && isTeamMember(resource.data.teamId)) ||
                     isUser(resource.data.createdBy) ||
                     isAdmin();
      
      // Team campaigns: coaches can create
      // Athlete campaigns: athlete's parent can create
      allow create: if isAuthenticated() && (
        (request.resource.data.type == 'team' && isTeamCoach(request.resource.data.teamId)) ||
        (request.resource.data.type == 'athlete' && request.resource.data.createdBy == request.auth.uid) ||
        isAdmin()
      );
      
      // Only campaign creator, team coach, or admin can update
      allow update: if isUser(resource.data.createdBy) || 
                       (resource.data.teamId != null && isTeamCoach(resource.data.teamId)) ||
                       isAdmin();
      
      // Only admin can delete campaigns
      allow delete: if isAdmin();
      
      // Campaign updates subcollection
      match /updates/{updateId} {
        allow read: if true; // Public
        allow create, update, delete: if isUser(get(/databases/$(database)/documents/campaigns/$(campaignId)).data.createdBy) ||
                                         isAdmin();
      }
    }

    // =============================================================================
    // DONATIONS COLLECTION
    // =============================================================================
    match /donations/{donationId} {
      // Campaign owners can read donations, donors can read their own
      allow read: if isUser(resource.data.donorUserId) ||
                     isUser(get(/databases/$(database)/documents/campaigns/$(resource.data.campaignId)).data.createdBy) ||
                     isAdmin();
      
      // Authenticated users can create donations
      allow create: if isAuthenticated();
      
      // Only admins can update/delete (for refund handling)
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // NIL DEALS COLLECTION
    // =============================================================================
    match /nilDeals/{dealId} {
      // Athlete and their parent can read their deals
      allow read: if isUser(resource.data.athleteId) ||
                     isUser(get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId) ||
                     isAdmin();
      
      // Athlete's parent can create deals
      allow create: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(request.resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Athlete's parent can update deals
      allow update: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // NIL PAYMENTS COLLECTION
    // =============================================================================
    match /nilPayments/{paymentId} {
      // Athlete and their parent can read their payments
      allow read: if isUser(resource.data.athleteId) ||
                     isUser(get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId) ||
                     isAdmin();
      
      // Athlete's parent can create payments
      allow create: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(request.resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Athlete's parent can update payments
      allow update: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // EXISTING COLLECTIONS (keep your existing rules here)
    // =============================================================================
    
    // Users collection
    match /users/{userId} {
      // Allow public read for public coach/referee profiles
      allow read: if true;
      
      // User creation - must be the authenticated user creating their own document
      // This is the FIRST operation for a new user, so we can't check getUserData()
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can update their own profile, but NOT credit-related fields
      // Credit fields can only be updated by SuperAdmin or server-side functions
      // teamsCreated is allowed so users can track their team creation count
      // Commissioners and Head Coaches can update coach teamIds to assign/unassign coaches
      allow update: if (isUser(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['credits', 'lifetimeCreditsEarned', 'lifetimeCreditsSpent', 'lifetimeCreditsGifted', 'lifetimeCreditsReceived', 'pilotProgramId', 'pilotExpiresAt'])) 
                    || isAdmin()
                    || (isCommissioner() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['teamIds', 'updatedAt']))
                    || (isCoach() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['teamIds', 'teamId', 'updatedAt']));
      
      // Only SuperAdmin can delete users
      allow delete: if isAdmin();
      
      // User's notifications subcollection
      // Used for: registration confirmations, decline notifications, draft notifications, etc.
      match /notifications/{notificationId} {
        // User can read their own notifications
        allow read: if isUser(userId);
        
        // Any authenticated user can create notifications for any user (coaches notifying parents, etc.)
        allow create: if isAuthenticated();
        
        // User can update (mark as read) or delete their own notifications
        allow update, delete: if isUser(userId) || isAdmin();
      }
      
      // User's plays subcollection (Coach Playbook)
      match /plays/{playId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }
      
      // User's formations subcollection
      match /formations/{formationId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }
      
      // User's imported playbooks
      match /importedPlaybooks/{playbookId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }
      
      // Coach announcements (public profile)
      match /announcements/{announcementId} {
        allow read: if true;
        allow write: if isUser(userId) || isAdmin();
        
        // Announcement comments
        match /comments/{commentId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
      }
      
      // Coach public chat messages
      match /publicChatMessages/{messageId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }
      
      // Coach/User followers (for public profiles)
      match /followers/{followerId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }
      
      // Coach muted users
      match /mutedUsers/{mutedId} {
        allow read: if isUser(userId);
        allow write: if isUser(userId);
      }
      
      // =============================================================================
      // PROMO ITEMS SUBCOLLECTION - Personal saved designs and player public promos
      // =============================================================================
      match /promoItems/{promoId} {
        // Owner can read all their promo items, public items visible to all
        allow read: if isUser(userId) || 
                       resource.data.isPublic == true || 
                       isAdmin();
        
        // User can create promo items in their own folder
        // Parents can also create promos for their players (playerId field)
        allow create: if isUser(userId) || 
                         (isAuthenticated() && request.resource.data.location == 'player') ||
                         isAdmin();
        
        // Owner or creator can update/delete
        allow update, delete: if isUser(userId) || 
                                 isUser(resource.data.createdBy) ||
                                 isAdmin();
      }
      
      // =============================================================================
      // CREDIT TRANSACTIONS - User's credit history
      // SECURITY: Only SuperAdmin can write transactions directly.
      // All credit operations should go through creditService which runs in trusted context.
      // Cloud Functions with admin SDK bypass these rules entirely.
      // =============================================================================
      match /creditTransactions/{transactionId} {
        // User can read their own transactions, admin can read all
        allow read: if isUser(userId) || isAdmin();
        
        // Users can create their own transactions (for welcome credits, migrations)
        // The creditService validates all operations before writing
        allow create: if isUser(userId) || isAdmin();
        
        // No updates or deletes on transaction history (immutable ledger)
        allow update, delete: if isAdmin();
      }
      
      // =============================================================================
      // USED PROMO CODES - Track which promo codes user has redeemed
      // =============================================================================
      match /usedPromoCodes/{codeId} {
        allow read: if isUser(userId) || isAdmin();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
      
      // =============================================================================
      // USER META SUBCOLLECTION - lastRead timestamps, preferences, etc.
      // =============================================================================
      match /meta/{metaId} {
        allow read: if isUser(userId) || isAdmin();
        allow write: if isUser(userId) || isAdmin();
      }
    }
    
    // =============================================================================
    // TEAM MANAGERS COLLECTION - Sub-accounts created by commissioners
    // Managers are created by commissioners to help manage their teams
    // =============================================================================
    match /teamManagers/{managerId} {
      // Helper to check if user is the commissioner who created this manager
      function isManagerOwner() {
        return resource.data.commissionerId == request.auth.uid;
      }
      
      function isCreatingManager() {
        return request.resource.data.commissionerId == request.auth.uid;
      }
      
      // Managers can read their own record
      // Commissioners can read managers they created
      // Admins can read all
      allow read: if isAuthenticated() && (
        request.auth.uid == managerId ||  // Manager reading own doc
        (resource.data.commissionerId == request.auth.uid) ||  // Commissioner who created
        isAdmin()
      );
      
      // Only commissioners can create managers (for their own teams)
      // The commissionerId must match the authenticated user
      allow create: if isAuthenticated() && isCreatingManager();
      
      // Commissioner who created can update, manager can update limited fields (lastLogin, loginCount)
      // Admin has full access
      allow update: if isAuthenticated() && (
        (resource.data.commissionerId == request.auth.uid) ||  // Commissioner
        (request.auth.uid == managerId && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLogin', 'loginCount', 'lastActivity'])) ||  // Manager can only update login tracking
        isAdmin()
      );
      
      // Only the commissioner who created the manager or admin can delete
      allow delete: if isAuthenticated() && (
        (resource.data.commissionerId == request.auth.uid) ||
        isAdmin()
      );
    }
    
    // =============================================================================
    // TOP-LEVEL PLAYERS COLLECTION - Unassigned/Free Agent Athletes
    // Players are stored here when:
    // 1. Created by parents before registering to a team
    // 2. Preserved when a team is deleted (moved from teams/{teamId}/players)
    // =============================================================================
    match /players/{playerId} {
      // Allow public read for public athlete profiles
      allow read: if true;
      
      // Parents can create players (their own children)
      allow create: if isAuthenticated();
      
      // Parents can update their own players, coaches can update for team registration,
      // commissioners can update draft pool info, admins have full access
      allow update: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid || // Parent owns this player
        isCoach() ||  // Coaches can update for team registration
        isCommissioner() || // Commissioners can update draft pool status
        isAdmin()
      );
      
      // Only parents (owner) or admin can delete unassigned players
      allow delete: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        isAdmin()
      );
      
      // Player's followers (fans) - for unassigned players
      match /followers/{followerId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }
      
      // =============================================================================
      // CAREER STATS v2.0 - Lifetime career stats per sport (written by Cloud Functions)
      // Path: players/{playerId}/careerStats/{sport}
      // =============================================================================
      match /careerStats/{sport} {
        // Anyone can read career stats (for public profiles, recruiting)
        allow read: if true;
        
        // Only Cloud Functions (admin SDK) should write career stats
        // Allow admin for manual corrections
        allow write: if isAdmin();
      }
      
      // =============================================================================
      // GAME LOG v2.0 - Complete game-by-game history (written by Cloud Functions)
      // Path: players/{playerId}/gameLog/{gameId}
      // =============================================================================
      match /gameLog/{gameId} {
        // Anyone can read game log (for public profiles)
        allow read: if true;
        
        // Only Cloud Functions (admin SDK) should write game log
        // Allow admin for manual corrections
        allow write: if isAdmin();
      }
    }
    
    // Teams collection
    match /teams/{teamId} {
      // Allow public read for public profiles (unauthenticated users can view teams/players)
      allow read: if true;
      // Any authenticated user can create teams (they become the owner)
      allow create: if isAuthenticated();
      // Team owner or authorized roles can update
      // Parents can add themselves to parentIds for chat access
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isTeamCoach(teamId) || 
        isCommissioner() || 
        isAdmin() ||
        // Allow any parent to update parentIds only (they add themselves for chat)
        (getUserData().role == 'Parent' && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['parentIds']))
      );
      // Team owner or admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      
      // Players subcollection
      match /players/{playerId} {
        // Allow public read for public athlete profiles
        allow read: if true;
        // Allow coaches assigned to this team, team owner, commissioner, admin, or parent of the player
        // For draft: Check if this is the coach's assigned team via team document
        allow write: if isCommissioner() || 
                       isAdmin() ||
                       isTeamOwner(teamId) ||
                       // Parent can update their own child's record (parentId or parentUserId match on player doc)
                       resource.data.parentId == request.auth.uid ||
                       resource.data.parentUserId == request.auth.uid ||
                       // Parent check via user's athleteIds array (safer - no additional get() needed)
                       (isParentOfPlayer() && resource.data.athleteId != null && isParentOfAthlete(resource.data.athleteId)) ||
                       // Fallback: Check top-level players collection for parentId (only if athleteId exists and doc exists)
                       (resource.data.athleteId != null && 
                        exists(/databases/$(database)/documents/players/$(resource.data.athleteId)) &&
                        get(/databases/$(database)/documents/players/$(resource.data.athleteId)).data.parentId == request.auth.uid) ||
                       // PARENT CLAIM: Allow authenticated user to claim ownership by setting parentId to themselves
                       // Safe because they can ONLY set it to their own UID (not impersonate others)
                       (isAuthenticated() && 
                        request.resource.data.parentId == request.auth.uid &&
                        request.resource.data.parentUserId == request.auth.uid) ||
                       // Team owner (coach who created the team)
                       get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid ||
                       // Check if coach is assigned to this team (via team document fields)
                       (isCoach() && (
                         get(/databases/$(database)/documents/teams/$(teamId)).data.coachId == request.auth.uid ||
                         get(/databases/$(database)/documents/teams/$(teamId)).data.headCoachId == request.auth.uid ||
                         get(/databases/$(database)/documents/teams/$(teamId)).data.offensiveCoordinatorId == request.auth.uid ||
                         get(/databases/$(database)/documents/teams/$(teamId)).data.defensiveCoordinatorId == request.auth.uid ||
                         (get(/databases/$(database)/documents/teams/$(teamId)).data.coachIds != null && 
                          request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.coachIds)
                       ));
        
        // Player's film room (public for athlete profile viewing)
        match /filmRoom/{filmId} {
          allow read: if true;
          allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isCommissioner() || isAdmin();
        }
        
        // Player's followers (fans)
        match /followers/{followerId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Player's kudos
        match /kudos/{kudosId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Fan clips
        match /fanClips/{clipId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Public chat messages
        match /publicChatMessages/{messageId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Public chat muted
        match /publicChatMuted/{mutedId} {
          allow read: if isTeamCoach(teamId);
          allow write: if isTeamCoach(teamId);
        }
      }
      
      // Plays subcollection (Team Playbook)
      match /plays/{playId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
      
      // Assigned plays subcollection
      match /assignedPlays/{assignmentId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
        
        // Position assignments
        match /positionAssignments/{positionId} {
          allow read: if isAuthenticated();
          allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
        }
      }
      
      // Team events subcollection
      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
      
      // Team announcements/bulletin
      match /announcements/{announcementId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
      
      // Coaches subcollection
      match /coaches/{coachId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
      
      // Player stats subcollection
      match /playerStats/{statId} {
        // Allow public read for public athlete profiles
        allow read: if true;
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
      
      // Live streams subcollection
      match /liveStreams/{streamId} {
        allow read: if true;
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Team chat messages (legacy path: /messages)
      // Updated: Jan 17 2026 - Allow parents with children on team to access chat
      match /messages/{messageId} {
        allow read: if isTeamMember(teamId) || isTeamCoach(teamId) || isTeamProgramCommissioner(teamId) || isParentOnTeam(teamId) || isAdmin();
        allow write: if isTeamMember(teamId) || isTeamCoach(teamId) || isTeamProgramCommissioner(teamId) || isParentOnTeam(teamId) || isAdmin();
      }
      
      // Team chat subcollection (used by CommissionerTeamChat)
      // Updated: Jan 17 2026 - Allow parents with children on team to access chat
      match /chat/{messageId} {
        allow read: if isTeamMember(teamId) || isTeamCoach(teamId) || isTeamProgramCommissioner(teamId) || isParentOnTeam(teamId) || isAdmin();
        allow write: if isTeamMember(teamId) || isTeamCoach(teamId) || isTeamProgramCommissioner(teamId) || isParentOnTeam(teamId) || isAdmin();
      }
      
      // Team chat muted users
      // Updated: Jan 17 2026 - Allow program commissioners to manage muted users
      match /mutedUsers/{mutedId} {
        allow read: if isTeamCoach(teamId) || isTeamProgramCommissioner(teamId) || isAdmin();
        allow write: if isTeamCoach(teamId) || isTeamProgramCommissioner(teamId) || isAdmin();
      }
      
      // Season stats subcollection
      match /seasonStats/{statId} {
        // Allow public read for public athlete profiles
        allow read: if true;
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Games subcollection - Team game schedules
      // Updated: Dec 31 2025 - Added protection for league-managed games and completed games
      // Updated: Dec 31 2025 - Allow league owners to manage league-created games
      // Updated: Jan 17 2026 - Allow program commissioners to manage program-managed games
      match /games/{gameId} {
        // Allow public read for public profiles
        allow read: if true;
        
        // Create: Team coaches can create their own games, OR league can create league-managed games
        // OR program commissioners can create program-managed games
        allow create: if isTeamCoach(teamId) || isAdmin() || (
          // Allow league owners to create league-managed games for their teams
          isAuthenticated() && 
          request.resource.data.leagueManaged == true &&
          request.resource.data.leagueId != null
        ) || (
          // Allow program commissioners to create program-managed games for their teams
          isAuthenticated() && 
          request.resource.data.programManaged == true &&
          request.resource.data.programId != null &&
          canManageProgram(request.resource.data.programId)
        );
        
        // Update: Team coaches can update non-league games, 
        // OR update score/status fields on any game (for game day tracking)
        // League owners can update their league-managed games
        // Program commissioners can update their program-managed games
        allow update: if isAdmin() || (
          // League owners can fully update their league-managed games
          resource.data.leagueManaged == true && 
          resource.data.leagueId != null &&
          isLeagueOwnerOf(resource.data.leagueId)
        ) || (
          // Program commissioners can fully update their program-managed games
          resource.data.programManaged == true && 
          resource.data.programId != null &&
          canManageProgram(resource.data.programId)
        ) || (
          isTeamCoach(teamId) && (
            // Non-league games: full edit access
            resource.data.leagueManaged != true ||
            // League games: only allow score/status/quarter updates (not game details like date/time/opponent)
            request.resource.data.diff(resource.data).affectedKeys().hasOnly([
              'ourScore', 'opponentScore', 'status', 'result', 'statsEntered', 
              'statsId', 'updatedAt', 'notes',
              // Quarter tracking for live game scoring
              'currentQuarter', 'homeQ1', 'homeQ2', 'homeQ3', 'homeQ4', 'homeOT',
              'awayQ1', 'awayQ2', 'awayQ3', 'awayQ4', 'awayOT',
              'homeScore', 'awayScore', 'startedAt', 'endedAt'
            ])
          )
        );
        
        // Delete: 
        // - Admins can always delete
        // - League owners can delete their league-managed games
        // - Program commissioners can delete their program-managed games
        // - Team coaches can delete non-league games that are NOT completed with scores
        // - NEVER allow deletion of completed games with scores (data integrity protection)
        allow delete: if isAdmin() || (
          // League owners can delete their league-managed games (for re-scheduling)
          resource.data.leagueManaged == true && 
          resource.data.leagueId != null &&
          isLeagueOwnerOf(resource.data.leagueId) &&
          !(resource.data.status == 'completed' && resource.data.ourScore != null)
        ) || (
          // Program commissioners can delete their program-managed games (for re-scheduling)
          resource.data.programManaged == true && 
          resource.data.programId != null &&
          canManageProgram(resource.data.programId) &&
          !(resource.data.status == 'completed' && resource.data.ourScore != null)
        ) || (
          isTeamCoach(teamId) &&
          resource.data.leagueManaged != true &&
          !(resource.data.status == 'completed' && resource.data.ourScore != null)
        );
        
        // Player stats for this game (public for athlete profiles)
        match /playerStats/{playerId} {
          allow read: if true;
          allow write: if isTeamCoach(teamId) || isAdmin();
        }
        
        // Game stats v2 (for league games - stored under games/{gameId}/stats/{playerId})
        match /stats/{playerId} {
          allow read: if true;
          allow write: if isTeamCoach(teamId) || isAdmin();
        }
      }
      
      // Videos subcollection
      match /videos/{videoId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Strategies subcollection
      match /strategies/{strategyId} {
        allow read: if isTeamMember(teamId);
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Bulletin subcollection (legacy)
      match /bulletin/{bulletinId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Bulletins subcollection (commissioner announcements)
      match /bulletins/{bulletinId} {
        // Team members and public can read bulletins
        allow read: if true;
        
        // Team owner (commissioner), coach, or admin can create/update/delete bulletins
        // Check if user is the team owner OR is a commissioner
        allow create: if isAuthenticated() && (
          resource == null || 
          get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid ||
          isCommissioner() ||
          isTeamCoach(teamId) ||
          isAdmin()
        );
        allow update: if isAuthenticated() && (
          get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid ||
          resource.data.creatorId == request.auth.uid ||
          isCommissioner() ||
          isTeamCoach(teamId) ||
          isAdmin()
        );
        allow delete: if isAuthenticated() && (
          get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid ||
          resource.data.creatorId == request.auth.uid ||
          isCommissioner() ||
          isTeamCoach(teamId) ||
          isAdmin()
        );
      }
      
      // =============================================================================
      // PROMO ITEMS SUBCOLLECTION - Saved flyers and promotional materials
      // =============================================================================
      match /promoItems/{promoId} {
        // Team members can read promo items, public items visible to all
        allow read: if resource.data.isPublic == true || 
                       isTeamMember(teamId) || 
                       isAdmin();
        
        // Only coaches can create promo items for the team
        allow create: if isTeamCoach(teamId) || isAdmin();
        
        // Coaches can update/delete team promo items
        allow update, delete: if isTeamCoach(teamId) || isAdmin();
      }
      
      // =============================================================================
      // SEASONS SUBCOLLECTION - Season management for teams
      // =============================================================================
      match /seasons/{seasonId} {
        // Anyone can read seasons (for public registration pages)
        allow read: if true;
        
        // Only coaches can create/update/delete seasons
        allow create: if isTeamCoach(teamId) || isAdmin();
        allow update: if isTeamCoach(teamId) || isAdmin();
        allow delete: if isTeamCoach(teamId) || isAdmin();
        
        // Season registrations subcollection
        match /registrations/{registrationId} {
          // Coaches can read all registrations, parents can read their own
          allow read: if isTeamCoach(teamId) || 
                         isUser(resource.data.parentId) || 
                         isAdmin();
          
          // Parents can create registrations for their players
          allow create: if isAuthenticated() && 
                           request.resource.data.parentId == request.auth.uid;
          
          // Coaches can update (approve/reject), parents can update pending registrations
          allow update: if isTeamCoach(teamId) || 
                           (isUser(resource.data.parentId) && resource.data.status == 'pending') ||
                           isAdmin();
          
          // Only coaches/admin can delete registrations
          allow delete: if isTeamCoach(teamId) || isAdmin();
        }
      }
      
      // =============================================================================
      // DRAFT POOL SUBCOLLECTION - Waitlist for team registrations
      // Players waiting to be drafted to roster by coach/commissioner
      // =============================================================================
      match /draftPool/{entryId} {
        // Anyone authenticated can read draft pool entries (parents, athletes, coaches, commissioners)
        // This allows parents/athletes to see their position in the pool
        allow read: if isAuthenticated();
        
        // Anyone authenticated can create entries (parent registering child, or athlete self-registering)
        allow create: if isAuthenticated();
        
        // Only coaches, team owner (commissioner), or admin can update entries
        // This includes drafting to roster, updating payment status, declining
        allow update: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
        
        // Only coaches, team owner, or admin can delete entries
        allow delete: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
    }
    
    // Athletes collection
    match /athletes/{athleteId} {
      allow read: if isAuthenticated();
      allow write: if isTeamCoach(resource.data.teamId) || 
                      isUser(resource.data.parentUserId) || 
                      isAdmin();
    }
    
    // =============================================================================
    // COACH KUDOS & FEEDBACK (Public profiles)
    // =============================================================================
    
    // Coach Kudos - Public read for profile display
    match /coachKudos/{kudosId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // Coach Feedback - Private, only admin can view
    match /coachFeedback/{feedbackId} {
      allow read: if isAdmin() || 
                    (isAuthenticated() && resource.data.coachId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // =============================================================================
    // LEAGUE SEASONS & SCHEDULES (Top-level for public queries)
    // =============================================================================
    
    // League Seasons - Public read for league pages
    match /leagueSeasons/{seasonId} {
      allow read: if true;
      // Allow create if user is league owner of the league specified in the document
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwnerOf(request.resource.data.leagueId)
      );
      // Allow update if user is league owner OR a commissioner (for team finalization)
      // Commissioners need to update programFinalizations for their program
      allow update: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwnerOf(resource.data.leagueId) ||
        // Allow commissioners to update for team finalization
        // They can only update programFinalizations for their own program (enforced in code)
        isCommissioner()
      );
      allow delete: if isAdmin() || isLeagueOwnerOf(resource.data.leagueId);
    }
    
    // League Schedules - Public read for league pages
    // Updated: Dec 31 2025 - Added protection for completed games
    match /leagueSchedules/{scheduleId} {
      allow read: if true;
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwnerOf(request.resource.data.leagueId)
      );
      // Allow update but note: completed games protection is enforced in application layer
      // since games are stored as an array and Firestore can't check array element status
      allow update: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwnerOf(resource.data.leagueId)
      );
      // Prevent full schedule deletion if it contains completed games
      // Note: Application layer should also validate this
      allow delete: if isAdmin();
    }
    
    // League Games - Public read for league pages
    // Updated: Dec 31 2025 - Prevent deletion of completed games (data integrity)
    match /leagueGames/{gameId} {
      allow read: if true;
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwnerOf(request.resource.data.leagueId)
      );
      allow update: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwnerOf(resource.data.leagueId)
      );
      // Only allow delete if game is NOT completed with scores
      allow delete: if isAdmin() || (
        isLeagueOwnerOf(resource.data.leagueId) &&
        resource.data.status != 'completed'
      );
    }
    
    // =============================================================================
    // SYSTEM COLLECTIONS (Admin-managed playbooks, plays, formations)
    // =============================================================================
    
    // System Playbooks (published playbook packages)
    match /systemPlaybooks/{playbookId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System Plays (plays within playbook packages)
    match /systemPlays/{playId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System Formations (formations within playbook packages)
    match /systemFormations/{formationId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // =============================================================================
    // SETTINGS & CONFIGURATION
    // =============================================================================
    
    // App Settings (SuperAdmin only write, public read for app config before auth)
    match /appConfig/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Monetization & Credit Settings (SuperAdmin only)
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Payment logs (admin read only)
    match /paymentLogs/{logId} {
      allow read: if isAdmin();
      allow create: if true; // Cloud function creates these
      allow update, delete: if isAdmin();
    }
    
    // =============================================================================
    // ADMIN AUDIT LOG - Security compliance logging
    // =============================================================================
    match /adminAuditLog/{logId} {
      // Only SuperAdmin can read audit logs
      allow read: if isAdmin();
      // Authenticated users can create (service creates on behalf of admin)
      allow create: if isAuthenticated();
      // No updates or deletes - audit log is immutable
      allow update, delete: if false;
    }
    
    // =============================================================================
    // GRIEVANCE CHATS - Parent-Admin communication for grievances
    // =============================================================================
    match /grievance_chats/{chatId} {
      // Parent can read their own chats, commissioners and admin can read all
      allow read: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        isCommissioner() ||
        isAdmin()
      );
      
      // Parents and commissioners can create grievance chats
      allow create: if isAuthenticated();
      
      // Participants can update (add messages, update status)
      allow update: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        isCommissioner() ||
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
    }
    
    // =============================================================================
    // INFRACTIONS - Team/player infractions reported by commissioners
    // =============================================================================
    match /infractions/{infractionId} {
      // Commissioners and admin can read infractions
      allow read: if isAuthenticated() && (
        isCommissioner() ||
        isAdmin() ||
        resource.data.reportedBy == request.auth.uid
      );
      
      // Commissioners can create infractions
      allow create: if isAuthenticated() && (isCommissioner() || isAdmin());
      
      // Commissioners and admin can update (change status, add notes)
      allow update: if isAuthenticated() && (isCommissioner() || isAdmin());
      
      // Only admin can delete
      allow delete: if isAdmin();
      
      // Infraction thread messages
      match /messages/{messageId} {
        allow read: if isAuthenticated() && (isCommissioner() || isAdmin());
        allow create: if isAuthenticated() && (isCommissioner() || isAdmin());
        allow update, delete: if isAdmin();
      }
    }
    
    // =============================================================================
    // COMMISSIONER BULLETINS - Announcements from commissioners to their teams
    // =============================================================================
    match /commissionerBulletins/{bulletinId} {
      // Commissioners can read their own bulletins, admin can read all
      allow read: if isAuthenticated() && (
        isCommissioner() || 
        isAdmin()
      );
      
      // Commissioners can create bulletins
      allow create: if isCommissioner();
      
      // Creator or admin can update bulletins
      allow update: if isAuthenticated() && (
        resource.data.creatorId == request.auth.uid ||
        isCommissioner() ||
        isAdmin()
      );
      
      // Creator or admin can delete bulletins
      allow delete: if isAuthenticated() && (
        resource.data.creatorId == request.auth.uid || 
        isCommissioner() ||
        isAdmin()
      );
    }
    
    // =============================================================================
    // PRIVATE CHATS - Direct messaging between users
    // =============================================================================
    match /private_chats/{chatId} {
      // Only participants can read the chat
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // Authenticated users can create private chats
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
      
      // Participants can update (new messages, read status, etc.)
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // Participants can delete their own chats, or admin can delete any
      allow delete: if isAuthenticated() && request.auth.uid in resource.data.participants || isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        // Parent doc access check isn't available in subcollection, so use simpler check
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        // Sender can delete their own message, or admin can delete any
        allow update: if isAuthenticated() && (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.userId);
        allow delete: if isAuthenticated() && (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.userId) || isAdmin();
      }
    }

    // =============================================================================
    // PROGRAMS COLLECTION (Commissioner managed sports programs)
    // =============================================================================
    match /programs/{programId} {
      // Anyone can read programs (for registration pages)
      allow read: if true;
      
      // Only commissioners can create programs
      allow create: if isCommissioner() && request.resource.data.ownerId == request.auth.uid;
      
      // Owner or admin can update
      allow update: if isUser(resource.data.ownerId) || isAdmin();
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // SEASONS COLLECTION (Registration periods for programs)
    // =============================================================================
    match /seasons/{seasonId} {
      // Anyone can read seasons (for registration)
      allow read: if true;
      
      // Program owner or admin can create seasons
      allow create: if isCommissioner() && request.resource.data.ownerId == request.auth.uid;
      
      // Owner or admin can update (includes registration count increments)
      allow update: if isUser(resource.data.ownerId) || isAdmin() || isAuthenticated();
      
      // Only admin can delete
      allow delete: if isAdmin();
      
      // Draft pool subcollection
      match /draftPool/{playerId} {
        // Commissioners and coaches can read draft pool
        allow read: if isAuthenticated();
        
        // System creates entries via registration (authenticated users)
        allow create: if isAuthenticated();
        
        // Commissioners, coaches and admins can update (for draft operations)
        allow update: if isAuthenticated();
        
        // Commissioners, coaches and admins can delete (decline players)
        allow delete: if isAuthenticated();
      }
    }
    
    // Admin Activity Log - for tracking important actions
    match /adminActivityLog/{logId} {
      // Only admins can read logs
      allow read: if isAdmin();
      
      // Any coach, commissioner, or admin can create log entries
      allow create: if isAuthenticated() && (isCoach() || isCommissioner() || isAdmin());
      
      // No updates or deletes (logs are immutable)
      allow update, delete: if false;
    }
    
    // =============================================================================
    // COLLECTION GROUP RULES
    // These rules apply to collectionGroup queries across all subcollections
    // =============================================================================
    
    // Allow parents to query their own athletes across all team rosters
    // Used by AuthContext to find all players linked to parent across all teams
    // Query must filter by parentId == request.auth.uid
    match /{path=**}/players/{playerId} {
      allow read: if isAuthenticated() && 
                    (resource.data.parentId == request.auth.uid || 
                     isAdmin() || 
                     isCoach());
    }
    
    // Allow parents to query their own registrations across all programs
    // Allow coaches to query registrations for their program (draft pool)
    // Used by ParentRegistrations.tsx, AuthContext sport context detection, and coach draft pool
    // Query must filter by parentId == request.auth.uid for parents
    match /{path=**}/registrants/{registrantId} {
      allow read: if isAuthenticated() && 
                    (resource.data.parentId == request.auth.uid || 
                     isAdmin() || 
                     isCommissioner() ||
                     isCoach());
    }
  }
}
