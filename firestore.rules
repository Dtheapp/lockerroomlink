rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isCoach() {
      return isAuthenticated() && getUserData().role == 'Coach';
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'SuperAdmin';
    }
    
    // --- Commissioner Role Checks ---
    function isLeagueOwner() {
      return isAuthenticated() && getUserData().role == 'LeagueOwner';
    }
    
    function isLeagueCommissioner() {
      return isAuthenticated() && (getUserData().role == 'LeagueCommissioner' || getUserData().role == 'ProgramCommissioner' || getUserData().role == 'Commissioner');
    }
    
    function isTeamCommissioner() {
      return isAuthenticated() && getUserData().role == 'TeamCommissioner';
    }
    
    function isCommissioner() {
      return isLeagueCommissioner() || isTeamCommissioner() || isLeagueOwner();
    }
    
    function isReferee() {
      return isAuthenticated() && getUserData().role == 'Referee';
    }
    
    function isLeagueOwnerOf(leagueId) {
      return isLeagueOwner() && getUserData().leagueId == leagueId;
    }
    
    function isLeagueCommissionerOf(programId) {
      return isLeagueCommissioner() && getUserData().programId == programId;
    }
    
    function isAssistantCommissionerOf(programId) {
      return isAuthenticated() && 
             getUserData().isAssistantCommissioner == true && 
             getUserData().assistantForProgramId == programId;
    }
    
    function canManageProgram(programId) {
      return isLeagueCommissionerOf(programId) || 
             isAssistantCommissionerOf(programId) || 
             isAdmin();
    }
    
    function isTeamCoach(teamId) {
      return isCoach() && (
        getUserData().teamId == teamId ||
        (getUserData().teamIds != null && teamId in getUserData().teamIds)
      );
    }
    
    function isTeamOwner(teamId) {
      return isCommissioner() && 
             get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid;
    }
    
    function isTeamMember(teamId) {
      return isAuthenticated() && (
        getUserData().teamId == teamId || 
        (getUserData().teamIds != null && teamId in getUserData().teamIds)
      );
    }

    // =============================================================================
    // AI SESSIONS COLLECTION (for /ailog page)
    // =============================================================================
    match /aiSessions/{sessionId} {
      // Authenticated users can read all sessions
      allow read: if isAuthenticated();
      
      // Only admin can create/update/delete sessions
      // (In practice, this is managed by the AI during development)
      allow create, update, delete: if isAdmin() || isAuthenticated();
    }

    // =============================================================================
    // LEAGUES COLLECTION
    // =============================================================================
    match /leagues/{leagueId} {
      // Allow public read for public league pages
      allow read: if true;
      
      // Only SuperAdmin can create leagues
      allow create: if isAdmin();
      
      // League owner or admin can update
      allow update: if isLeagueOwnerOf(leagueId) || isAdmin();
      
      // Only admin can delete leagues
      allow delete: if isAdmin();
      
      // League Seasons subcollection (public for league pages)
      match /seasons/{seasonId} {
        allow read: if true;
        allow create, update: if isLeagueOwnerOf(leagueId) || isAdmin();
        allow delete: if isAdmin();
      }
      
      // League Schedules subcollection (public for league pages)
      match /schedules/{scheduleId} {
        allow read: if true;
        allow create, update: if isLeagueOwnerOf(leagueId) || isAdmin();
        allow delete: if isLeagueOwnerOf(leagueId) || isAdmin();
      }
      
      // Playoff Brackets subcollection (public for league pages)
      match /brackets/{bracketId} {
        allow read: if true;
        allow create, update: if isLeagueOwnerOf(leagueId) || isAdmin();
        allow delete: if isLeagueOwnerOf(leagueId) || isAdmin();
      }
      
      // League Requests subcollection
      match /requests/{requestId} {
        allow read: if isLeagueOwnerOf(leagueId) || isAdmin() || 
                      (isLeagueCommissioner() && resource.data.requestedBy == request.auth.uid);
        allow create: if isLeagueCommissioner() || isAdmin();
        allow update: if isLeagueOwnerOf(leagueId) || isAdmin();
        allow delete: if isAdmin();
      }
      
      // League Announcements subcollection (public for league pages)
      match /announcements/{announcementId} {
        allow read: if true;
        allow create, update, delete: if isLeagueOwnerOf(leagueId) || isAdmin();
      }
    }
    
    // =============================================================================
    // PROGRAMS COLLECTION
    // =============================================================================
    match /programs/{programId} {
      // Allow public read for public pages
      allow read: if true;
      
      // Only SuperAdmin can create programs initially
      allow create: if isAdmin();
      
      // Commissioner of the program or admin can update
      allow update: if canManageProgram(programId);
      
      // Only admin can delete programs
      allow delete: if isAdmin();
      
      // Grievances subcollection
      match /grievances/{grievanceId} {
        allow read: if canManageProgram(programId) || 
                      resource.data.submittedBy == request.auth.uid || 
                      isAdmin();
        allow create: if isAuthenticated();
        allow update: if canManageProgram(programId) || isAdmin();
        allow delete: if isAdmin();
      }
    }
    
    // =============================================================================
    // LEAGUE REQUESTS COLLECTION (top-level for querying)
    // =============================================================================
    match /leagueRequests/{requestId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isLeagueOwner() && resource.data.leagueId == getUserData().leagueId) ||
        resource.data.requestedBy == request.auth.uid
      );
      allow create: if isLeagueCommissioner() || isAdmin();
      allow update: if isAdmin() || 
                      (isLeagueOwner() && resource.data.leagueId == getUserData().leagueId);
      allow delete: if isAdmin();
    }
    
    // =============================================================================
    // GRIEVANCES COLLECTION (top-level for querying)
    // =============================================================================
    match /grievances/{grievanceId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isLeagueCommissioner() && resource.data.programId == getUserData().programId) ||
        resource.data.submittedBy == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAdmin() || 
                      (isLeagueCommissioner() && resource.data.programId == getUserData().programId);
      allow delete: if isAdmin();
    }
    
    // =============================================================================
    // TEAM SCHEDULE ACCEPTANCE COLLECTION
    // =============================================================================
    match /teamScheduleAcceptance/{acceptanceId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin() || 
                              isLeagueCommissioner() ||
                              isTeamCoach(resource.data.teamId);
      allow delete: if isAdmin();
    }

    // =============================================================================
    // REFEREE PROFILES COLLECTION
    // =============================================================================
    match /refereeProfiles/{refereeId} {
      // Anyone authenticated can read referee profiles (for searching/assigning)
      allow read: if isAuthenticated();
      
      // Users can create their own referee profile
      allow create: if isUser(refereeId);
      
      // Only the referee or admin can update their profile
      allow update: if isUser(refereeId) || isAdmin();
      
      // Only admin can delete referee profiles
      allow delete: if isAdmin();
    }

    // =============================================================================
    // REFEREE ASSIGNMENTS COLLECTION
    // =============================================================================
    match /refereeAssignments/{assignmentId} {
      // Referees can read their own assignments
      // League owners/commissioners can read assignments for their games
      // Admins can read all
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.refereeId == request.auth.uid ||
        (isLeagueOwner() && resource.data.leagueId == getUserData().leagueId) ||
        (isLeagueCommissioner() && exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
         get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.programId == getUserData().programId)
      );
      
      // League owners, commissioners, coaches can create assignments
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwner() ||
        isLeagueCommissioner() ||
        isCoach()
      );
      
      // Referees can update their own assignments (accept/decline)
      // League owners can update assignments for their league
      // Admins can update any
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.refereeId == request.auth.uid ||
        (isLeagueOwner() && resource.data.leagueId == getUserData().leagueId)
      );
      
      // Only admin or league owner can delete assignments
      allow delete: if isAdmin() || 
                      (isLeagueOwner() && resource.data.leagueId == getUserData().leagueId);
    }

    // =============================================================================
    // REFEREE NOTES COLLECTION (private to referee)
    // =============================================================================
    match /refereeNotes/{noteId} {
      // Only the referee who created the note can access it
      allow read, write: if isUser(resource.data.refereeId) || isAdmin();
      allow create: if isUser(request.resource.data.refereeId) || isAdmin();
    }

    // =============================================================================
    // REFEREE VERIFICATION REQUESTS COLLECTION
    // =============================================================================
    match /refereeVerificationRequests/{requestId} {
      // Referees can read their own requests, admins can read all
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.refereeId == request.auth.uid
      );
      
      // Referees can create verification requests
      allow create: if isUser(request.resource.data.refereeId);
      
      // Only admin can update (approve/reject)
      allow update: if isAdmin();
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // REFEREE RATINGS COLLECTION
    // =============================================================================
    match /refereeRatings/{ratingId} {
      // Anyone authenticated can read ratings
      allow read: if isAuthenticated();
      
      // League owners and coaches can create ratings
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwner() ||
        isLeagueCommissioner() ||
        isCoach()
      );
      
      // Only admin can update/delete ratings
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // REFEREE PAYMENTS COLLECTION
    // =============================================================================
    match /refereePayments/{paymentId} {
      // Referees can read their own payments, league owners can read payments for their league
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.refereeId == request.auth.uid ||
        (isLeagueOwner() && resource.data.leagueId == getUserData().leagueId)
      );
      
      // League owners can create payments
      allow create: if isAuthenticated() && (
        isAdmin() ||
        (isLeagueOwner() && request.resource.data.leagueId == getUserData().leagueId)
      );
      
      // Only admin can update/delete payments
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // NOTIFICATIONS COLLECTION
    // =============================================================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // System creates notifications (via services)
      allow create: if isAuthenticated();
      
      // Users can mark their own notifications as read
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      // Users can delete their own notifications, admin can delete any
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid
      );
    }

    // =============================================================================
    // GAME SCORE SUBMISSIONS COLLECTION
    // =============================================================================
    match /gameScoreSubmissions/{submissionId} {
      // Anyone authenticated can read score submissions
      allow read: if isAuthenticated();
      
      // Referees, coaches, league owners can create score submissions
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLeagueOwner() ||
        isLeagueCommissioner() ||
        isCoach() ||
        getUserData().role == 'Referee'
      );
      
      // Only admin can update/delete score submissions
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // EVENTS COLLECTION
    // =============================================================================
    match /events/{eventId} {
      // Public events can be read by anyone, all events can be read by authenticated users
      // This allows the "Find a Team" page to show public registration events
      allow read: if true;
      
      // Only coaches or commissioners (team owners) can create events for their teams
      allow create: if isTeamCoach(request.resource.data.teamId) || isTeamOwner(request.resource.data.teamId) || isAdmin();
      
      // Coaches or team owners can delete events
      allow delete: if isTeamCoach(resource.data.teamId) || isTeamOwner(resource.data.teamId) || isAdmin();
      
      // Coaches/owners can update fully, authenticated users can ONLY update currentCount and updatedAt (for registration)
      allow update: if isTeamCoach(resource.data.teamId) || isTeamOwner(resource.data.teamId) || isAdmin() ||
                      (isAuthenticated() && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentCount', 'updatedAt']));

      // =============================================================================
      // PRICING TIERS SUBCOLLECTION (nested under events)
      // =============================================================================
      match /pricingTiers/{tierId} {
        // Anyone can read pricing tiers (needed for registration page)
        allow read: if true;
        
        // Coaches or team owners (commissioners) can create/delete
        allow create: if isTeamCoach(get(/databases/$(database)/documents/events/$(eventId)).data.teamId) || 
                        isTeamOwner(get(/databases/$(database)/documents/events/$(eventId)).data.teamId) ||
                        isAdmin();
        allow delete: if isTeamCoach(get(/databases/$(database)/documents/events/$(eventId)).data.teamId) || 
                        isTeamOwner(get(/databases/$(database)/documents/events/$(eventId)).data.teamId) ||
                        isAdmin();
        
        // Update: coaches/owners can update everything, ANY authenticated user can update (for registration counter)
        // Security note: This is safe because pricing tiers only contain non-sensitive counter data
        allow update: if isAuthenticated();
      }
    }

    // =============================================================================
    // PRICING TIERS COLLECTION (legacy flat collection - keep for migration)
    // =============================================================================
    match /pricingTiers/{tierId} {
      // Anyone can read pricing tiers (needed for registration)
      allow read: if true;
      
      // Only coaches can create pricing tiers
      allow create: if isAuthenticated() && (
        isTeamCoach(get(/databases/$(database)/documents/events/$(request.resource.data.eventId)).data.teamId) || 
        isAdmin()
      );
      
      // Coaches can delete
      allow delete: if isAuthenticated() && (
        isTeamCoach(get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.teamId) || 
        isAdmin()
      );
      
      // Any authenticated user can update (for registration counter)
      allow update: if isAuthenticated();
    }

    // =============================================================================
    // PROMO CODES COLLECTION
    // =============================================================================
    match /promoCodes/{promoId} {
      // Coaches and team owners (commissioners) can read all promo codes for their events
      // Users can validate individual codes through Cloud Functions
      allow read: if isTeamCoach(resource.data.teamId) || isTeamOwner(resource.data.teamId) || isAdmin();
      
      // Coaches and team owners can create/delete promo codes
      allow create: if isTeamCoach(request.resource.data.teamId) || isTeamOwner(request.resource.data.teamId) || isAdmin();
      allow delete: if isTeamCoach(resource.data.teamId) || isTeamOwner(resource.data.teamId) || isAdmin();
      
      // Coaches/owners can update fully, authenticated users can ONLY update currentUses (for registration)
      allow update: if isTeamCoach(resource.data.teamId) || isTeamOwner(resource.data.teamId) || isAdmin() ||
                      (isAuthenticated() && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentUses']));
    }

    // =============================================================================
    // REGISTRATION ORDERS COLLECTION
    // =============================================================================
    match /registrationOrders/{orderId} {
      // Users can read their own orders, coaches can read orders for their events
      allow read: if isUser(resource.data.parentUserId) || 
                     isTeamCoach(resource.data.teamId) || 
                     isTeamOwner(resource.data.teamId) ||
                     isAdmin();
      
      // Authenticated users can create registration orders
      allow create: if isAuthenticated() && request.resource.data.parentUserId == request.auth.uid;
      
      // Users can update their own orders (for registration flow to add registrationIds)
      // Coaches and team owners can also update orders for their team
      allow update: if isUser(resource.data.parentUserId) ||
                       isTeamCoach(resource.data.teamId) || 
                       isTeamOwner(resource.data.teamId) ||
                       isAdmin();
      
      // Only admins can delete orders
      allow delete: if isAdmin();
    }

    // =============================================================================
    // REGISTRATIONS COLLECTION
    // =============================================================================
    match /registrations/{registrationId} {
      // Users can read their own registrations, coaches can read registrations for their events
      allow read: if isUser(resource.data.parentUserId) || 
                     isTeamCoach(resource.data.teamId) || 
                     isAdmin();
      
      // Authenticated users can create registrations (linked to their account)
      allow create: if isAuthenticated() && request.resource.data.parentUserId == request.auth.uid;
      
      // Users can update their pending registrations, coaches can update any registration
      allow update: if (isUser(resource.data.parentUserId) && resource.data.status in ['pending_payment', 'waitlisted']) ||
                       isTeamCoach(resource.data.teamId) || 
                       isAdmin();
      
      // Only coaches and admins can delete registrations
      allow delete: if isTeamCoach(resource.data.teamId) || isAdmin();
    }

    // =============================================================================
    // SIMPLE REGISTRATIONS COLLECTION (New clean system - supports both team and season based)
    // =============================================================================
    match /simpleRegistrations/{regId} {
      // Anyone authenticated can read registrations (for their own or team admins)
      allow read: if isAuthenticated();
      
      // Any authenticated user can create a registration
      allow create: if isAuthenticated() && request.resource.data.parentUserId == request.auth.uid;
      
      // User can update their own, coaches/admins can update any, or season owner
      allow update: if isUser(resource.data.parentUserId) || 
                       (resource.data.teamId != null && isTeamCoach(resource.data.teamId)) ||
                       (resource.data.teamId != null && isTeamOwner(resource.data.teamId)) ||
                       isCommissioner() ||
                       isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // TEAM PAYMENT SETTINGS COLLECTION
    // =============================================================================
    match /teamPaymentSettings/{teamId} {
      // Coaches can read/write their team's payment settings
      allow read, write: if isTeamCoach(teamId) || isAdmin();
    }

    // =============================================================================
    // CONTENT REPORTS COLLECTION (Moderation System)
    // =============================================================================
    match /contentReports/{reportId} {
      // Only admins and team coaches can read reports
      allow read: if isAdmin() || isTeamCoach(resource.data.teamId);
      
      // Any authenticated user can create a report (for their own team's content)
      allow create: if isAuthenticated() && 
                       request.resource.data.reportedBy == request.auth.uid &&
                       request.resource.data.status == 'pending';
      
      // Only admins can update reports (for review process)
      allow update: if isAdmin();
      
      // Only admins can delete reports
      allow delete: if isAdmin();
    }

    // =============================================================================
    // USER FEEDBACK COLLECTION
    // =============================================================================
    match /feedback/{feedbackId} {
      // Only admins can read feedback
      allow read: if isAdmin();
      
      // Any authenticated user can create feedback
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'new';
      
      // Only admins can update/delete feedback
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // FUNDRAISING CAMPAIGNS COLLECTION
    // =============================================================================
    match /campaigns/{campaignId} {
      // Public campaigns can be read by anyone, private by team members
      allow read: if resource.data.isPublic == true || 
                     (resource.data.teamId != null && isTeamMember(resource.data.teamId)) ||
                     isUser(resource.data.createdBy) ||
                     isAdmin();
      
      // Team campaigns: coaches can create
      // Athlete campaigns: athlete's parent can create
      allow create: if isAuthenticated() && (
        (request.resource.data.type == 'team' && isTeamCoach(request.resource.data.teamId)) ||
        (request.resource.data.type == 'athlete' && request.resource.data.createdBy == request.auth.uid) ||
        isAdmin()
      );
      
      // Only campaign creator, team coach, or admin can update
      allow update: if isUser(resource.data.createdBy) || 
                       (resource.data.teamId != null && isTeamCoach(resource.data.teamId)) ||
                       isAdmin();
      
      // Only admin can delete campaigns
      allow delete: if isAdmin();
      
      // Campaign updates subcollection
      match /updates/{updateId} {
        allow read: if true; // Public
        allow create, update, delete: if isUser(get(/databases/$(database)/documents/campaigns/$(campaignId)).data.createdBy) ||
                                         isAdmin();
      }
    }

    // =============================================================================
    // DONATIONS COLLECTION
    // =============================================================================
    match /donations/{donationId} {
      // Campaign owners can read donations, donors can read their own
      allow read: if isUser(resource.data.donorUserId) ||
                     isUser(get(/databases/$(database)/documents/campaigns/$(resource.data.campaignId)).data.createdBy) ||
                     isAdmin();
      
      // Authenticated users can create donations
      allow create: if isAuthenticated();
      
      // Only admins can update/delete (for refund handling)
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // NIL DEALS COLLECTION
    // =============================================================================
    match /nilDeals/{dealId} {
      // Athlete and their parent can read their deals
      allow read: if isUser(resource.data.athleteId) ||
                     isUser(get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId) ||
                     isAdmin();
      
      // Athlete's parent can create deals
      allow create: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(request.resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Athlete's parent can update deals
      allow update: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // NIL PAYMENTS COLLECTION
    // =============================================================================
    match /nilPayments/{paymentId} {
      // Athlete and their parent can read their payments
      allow read: if isUser(resource.data.athleteId) ||
                     isUser(get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId) ||
                     isAdmin();
      
      // Athlete's parent can create payments
      allow create: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(request.resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Athlete's parent can update payments
      allow update: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // EXISTING COLLECTIONS (keep your existing rules here)
    // =============================================================================
    
    // Users collection
    match /users/{userId} {
      // Allow public read for public coach/referee profiles
      allow read: if true;
      
      // User creation - must be the authenticated user creating their own document
      // This is the FIRST operation for a new user, so we can't check getUserData()
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can update their own profile, but NOT credit-related fields
      // Credit fields can only be updated by SuperAdmin or server-side functions
      // teamsCreated is allowed so users can track their team creation count
      // Commissioners can update coach teamIds to assign/unassign coaches
      allow update: if (isUser(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['credits', 'lifetimeCreditsEarned', 'lifetimeCreditsSpent', 'lifetimeCreditsGifted', 'lifetimeCreditsReceived', 'pilotProgramId', 'pilotExpiresAt'])) 
                    || isAdmin()
                    || (isCommissioner() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['teamIds', 'updatedAt']));
      
      // Only SuperAdmin can delete users
      allow delete: if isAdmin();
      
      // User's plays subcollection (Coach Playbook)
      match /plays/{playId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }
      
      // User's formations subcollection
      match /formations/{formationId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }
      
      // User's imported playbooks
      match /importedPlaybooks/{playbookId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }
      
      // Coach announcements (public profile)
      match /announcements/{announcementId} {
        allow read: if true;
        allow write: if isUser(userId) || isAdmin();
        
        // Announcement comments
        match /comments/{commentId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
      }
      
      // Coach public chat messages
      match /publicChatMessages/{messageId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }
      
      // Coach/User followers (for public profiles)
      match /followers/{followerId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }
      
      // Coach muted users
      match /mutedUsers/{mutedId} {
        allow read: if isUser(userId);
        allow write: if isUser(userId);
      }
      
      // =============================================================================
      // PROMO ITEMS SUBCOLLECTION - Personal saved designs and player public promos
      // =============================================================================
      match /promoItems/{promoId} {
        // Owner can read all their promo items, public items visible to all
        allow read: if isUser(userId) || 
                       resource.data.isPublic == true || 
                       isAdmin();
        
        // User can create promo items in their own folder
        // Parents can also create promos for their players (playerId field)
        allow create: if isUser(userId) || 
                         (isAuthenticated() && request.resource.data.location == 'player') ||
                         isAdmin();
        
        // Owner or creator can update/delete
        allow update, delete: if isUser(userId) || 
                                 isUser(resource.data.createdBy) ||
                                 isAdmin();
      }
      
      // =============================================================================
      // CREDIT TRANSACTIONS - User's credit history
      // SECURITY: Only SuperAdmin can write transactions directly.
      // All credit operations should go through creditService which runs in trusted context.
      // Cloud Functions with admin SDK bypass these rules entirely.
      // =============================================================================
      match /creditTransactions/{transactionId} {
        // User can read their own transactions, admin can read all
        allow read: if isUser(userId) || isAdmin();
        
        // Users can create their own transactions (for welcome credits, migrations)
        // The creditService validates all operations before writing
        allow create: if isUser(userId) || isAdmin();
        
        // No updates or deletes on transaction history (immutable ledger)
        allow update, delete: if isAdmin();
      }
      
      // =============================================================================
      // USED PROMO CODES - Track which promo codes user has redeemed
      // =============================================================================
      match /usedPromoCodes/{codeId} {
        allow read: if isUser(userId) || isAdmin();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
      
      // =============================================================================
      // USER META SUBCOLLECTION - lastRead timestamps, preferences, etc.
      // =============================================================================
      match /meta/{metaId} {
        allow read: if isUser(userId) || isAdmin();
        allow write: if isUser(userId) || isAdmin();
      }
    }
    
    // =============================================================================
    // TEAM MANAGERS COLLECTION - Sub-accounts created by commissioners
    // Managers are created by commissioners to help manage their teams
    // =============================================================================
    match /teamManagers/{managerId} {
      // Helper to check if user is the commissioner who created this manager
      function isManagerOwner() {
        return resource.data.commissionerId == request.auth.uid;
      }
      
      function isCreatingManager() {
        return request.resource.data.commissionerId == request.auth.uid;
      }
      
      // Managers can read their own record
      // Commissioners can read managers they created
      // Admins can read all
      allow read: if isAuthenticated() && (
        request.auth.uid == managerId ||  // Manager reading own doc
        (resource.data.commissionerId == request.auth.uid) ||  // Commissioner who created
        isAdmin()
      );
      
      // Only commissioners can create managers (for their own teams)
      // The commissionerId must match the authenticated user
      allow create: if isAuthenticated() && isCreatingManager();
      
      // Commissioner who created can update, manager can update limited fields (lastLogin, loginCount)
      // Admin has full access
      allow update: if isAuthenticated() && (
        (resource.data.commissionerId == request.auth.uid) ||  // Commissioner
        (request.auth.uid == managerId && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLogin', 'loginCount', 'lastActivity'])) ||  // Manager can only update login tracking
        isAdmin()
      );
      
      // Only the commissioner who created the manager or admin can delete
      allow delete: if isAuthenticated() && (
        (resource.data.commissionerId == request.auth.uid) ||
        isAdmin()
      );
    }
    
    // =============================================================================
    // TOP-LEVEL PLAYERS COLLECTION - Unassigned/Free Agent Athletes
    // Players are stored here when:
    // 1. Created by parents before registering to a team
    // 2. Preserved when a team is deleted (moved from teams/{teamId}/players)
    // =============================================================================
    match /players/{playerId} {
      // Allow public read for public athlete profiles
      allow read: if true;
      
      // Parents can create players (their own children)
      allow create: if isAuthenticated();
      
      // Parents can update their own players, coaches can update for team registration,
      // admins have full access
      allow update: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid || // Parent owns this player
        isCoach() ||  // Coaches can update for team registration
        isAdmin()
      );
      
      // Only parents (owner) or admin can delete unassigned players
      allow delete: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        isAdmin()
      );
      
      // Player's followers (fans) - for unassigned players
      match /followers/{followerId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }
    }
    
    // Teams collection
    match /teams/{teamId} {
      // Allow public read for public profiles (unauthenticated users can view teams/players)
      allow read: if true;
      // Any authenticated user can create teams (they become the owner)
      allow create: if isAuthenticated();
      // Team owner or authorized roles can update
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isTeamCoach(teamId) || 
        isCommissioner() || 
        isAdmin()
      );
      // Team owner or admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      
      // Players subcollection
      match /players/{playerId} {
        // Allow public read for public athlete profiles
        allow read: if true;
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
        
        // Player's film room (public for athlete profile viewing)
        match /filmRoom/{filmId} {
          allow read: if true;
          allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
        }
        
        // Player's followers (fans)
        match /followers/{followerId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Player's kudos
        match /kudos/{kudosId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Fan clips
        match /fanClips/{clipId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Public chat messages
        match /publicChatMessages/{messageId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Public chat muted
        match /publicChatMuted/{mutedId} {
          allow read: if isTeamCoach(teamId);
          allow write: if isTeamCoach(teamId);
        }
      }
      
      // Plays subcollection (Team Playbook)
      match /plays/{playId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
      
      // Assigned plays subcollection
      match /assignedPlays/{assignmentId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
        
        // Position assignments
        match /positionAssignments/{positionId} {
          allow read: if isAuthenticated();
          allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
        }
      }
      
      // Team events subcollection
      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
      
      // Team announcements/bulletin
      match /announcements/{announcementId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
      
      // Coaches subcollection
      match /coaches/{coachId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
      
      // Player stats subcollection
      match /playerStats/{statId} {
        // Allow public read for public athlete profiles
        allow read: if true;
        allow write: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
      
      // Live streams subcollection
      match /liveStreams/{streamId} {
        allow read: if true;
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Team chat messages
      match /messages/{messageId} {
        allow read: if isTeamMember(teamId) || isAdmin();
        allow write: if isTeamMember(teamId) || isAdmin();
      }
      
      // Season stats subcollection
      match /seasonStats/{statId} {
        // Allow public read for public athlete profiles
        allow read: if true;
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Games subcollection
      match /games/{gameId} {
        // Allow public read for public profiles
        allow read: if true;
        allow write: if isTeamCoach(teamId) || isAdmin();
        
        // Player stats for this game (public for athlete profiles)
        match /playerStats/{playerId} {
          allow read: if true;
          allow write: if isTeamCoach(teamId) || isAdmin();
        }
      }
      
      // Videos subcollection
      match /videos/{videoId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Strategies subcollection
      match /strategies/{strategyId} {
        allow read: if isTeamMember(teamId);
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Bulletin subcollection (legacy)
      match /bulletin/{bulletinId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Bulletins subcollection (commissioner announcements)
      match /bulletins/{bulletinId} {
        // Team members and public can read bulletins
        allow read: if true;
        
        // Team owner (commissioner), coach, or admin can create/update/delete bulletins
        // Check if user is the team owner OR is a commissioner
        allow create: if isAuthenticated() && (
          resource == null || 
          get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid ||
          isCommissioner() ||
          isTeamCoach(teamId) ||
          isAdmin()
        );
        allow update: if isAuthenticated() && (
          get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid ||
          resource.data.creatorId == request.auth.uid ||
          isCommissioner() ||
          isTeamCoach(teamId) ||
          isAdmin()
        );
        allow delete: if isAuthenticated() && (
          get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid ||
          resource.data.creatorId == request.auth.uid ||
          isCommissioner() ||
          isTeamCoach(teamId) ||
          isAdmin()
        );
      }
      
      // =============================================================================
      // PROMO ITEMS SUBCOLLECTION - Saved flyers and promotional materials
      // =============================================================================
      match /promoItems/{promoId} {
        // Team members can read promo items, public items visible to all
        allow read: if resource.data.isPublic == true || 
                       isTeamMember(teamId) || 
                       isAdmin();
        
        // Only coaches can create promo items for the team
        allow create: if isTeamCoach(teamId) || isAdmin();
        
        // Coaches can update/delete team promo items
        allow update, delete: if isTeamCoach(teamId) || isAdmin();
      }
      
      // =============================================================================
      // SEASONS SUBCOLLECTION - Season management for teams
      // =============================================================================
      match /seasons/{seasonId} {
        // Anyone can read seasons (for public registration pages)
        allow read: if true;
        
        // Only coaches can create/update/delete seasons
        allow create: if isTeamCoach(teamId) || isAdmin();
        allow update: if isTeamCoach(teamId) || isAdmin();
        allow delete: if isTeamCoach(teamId) || isAdmin();
        
        // Season registrations subcollection
        match /registrations/{registrationId} {
          // Coaches can read all registrations, parents can read their own
          allow read: if isTeamCoach(teamId) || 
                         isUser(resource.data.parentId) || 
                         isAdmin();
          
          // Parents can create registrations for their players
          allow create: if isAuthenticated() && 
                           request.resource.data.parentId == request.auth.uid;
          
          // Coaches can update (approve/reject), parents can update pending registrations
          allow update: if isTeamCoach(teamId) || 
                           (isUser(resource.data.parentId) && resource.data.status == 'pending') ||
                           isAdmin();
          
          // Only coaches/admin can delete registrations
          allow delete: if isTeamCoach(teamId) || isAdmin();
        }
      }
      
      // =============================================================================
      // DRAFT POOL SUBCOLLECTION - Waitlist for team registrations
      // Players waiting to be drafted to roster by coach/commissioner
      // =============================================================================
      match /draftPool/{entryId} {
        // Anyone authenticated can read draft pool entries (parents, athletes, coaches, commissioners)
        // This allows parents/athletes to see their position in the pool
        allow read: if isAuthenticated();
        
        // Anyone authenticated can create entries (parent registering child, or athlete self-registering)
        allow create: if isAuthenticated();
        
        // Only coaches, team owner (commissioner), or admin can update entries
        // This includes drafting to roster, updating payment status, declining
        allow update: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
        
        // Only coaches, team owner, or admin can delete entries
        allow delete: if isTeamCoach(teamId) || isTeamOwner(teamId) || isAdmin();
      }
    }
    
    // Athletes collection
    match /athletes/{athleteId} {
      allow read: if isAuthenticated();
      allow write: if isTeamCoach(resource.data.teamId) || 
                      isUser(resource.data.parentUserId) || 
                      isAdmin();
    }
    
    // =============================================================================
    // COACH KUDOS & FEEDBACK (Public profiles)
    // =============================================================================
    
    // Coach Kudos - Public read for profile display
    match /coachKudos/{kudosId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // Coach Feedback - Private, only admin can view
    match /coachFeedback/{feedbackId} {
      allow read: if isAdmin() || 
                    (isAuthenticated() && resource.data.coachId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // =============================================================================
    // LEAGUE SEASONS & SCHEDULES (Top-level for public queries)
    // =============================================================================
    
    // League Seasons - Public read for league pages
    match /leagueSeasons/{seasonId} {
      allow read: if true;
      allow create, update: if isLeagueOwner() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // League Schedules - Public read for league pages
    match /leagueSchedules/{scheduleId} {
      allow read: if true;
      allow create, update: if isLeagueOwner() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // League Games - Public read for league pages
    match /leagueGames/{gameId} {
      allow read: if true;
      allow create, update: if isLeagueOwner() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // =============================================================================
    // SYSTEM COLLECTIONS (Admin-managed playbooks, plays, formations)
    // =============================================================================
    
    // System Playbooks (published playbook packages)
    match /systemPlaybooks/{playbookId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System Plays (plays within playbook packages)
    match /systemPlays/{playId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System Formations (formations within playbook packages)
    match /systemFormations/{formationId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // =============================================================================
    // SETTINGS & CONFIGURATION
    // =============================================================================
    
    // App Settings (SuperAdmin only write, public read for app config before auth)
    match /appConfig/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Monetization & Credit Settings (SuperAdmin only)
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Payment logs (admin read only)
    match /paymentLogs/{logId} {
      allow read: if isAdmin();
      allow create: if true; // Cloud function creates these
      allow update, delete: if isAdmin();
    }
    
    // =============================================================================
    // ADMIN AUDIT LOG - Security compliance logging
    // =============================================================================
    match /adminAuditLog/{logId} {
      // Only SuperAdmin can read audit logs
      allow read: if isAdmin();
      // Authenticated users can create (service creates on behalf of admin)
      allow create: if isAuthenticated();
      // No updates or deletes - audit log is immutable
      allow update, delete: if false;
    }
    
    // =============================================================================
    // GRIEVANCE CHATS - Parent-Admin communication for grievances
    // =============================================================================
    match /grievance_chats/{chatId} {
      // Parent can read their own chats, commissioners and admin can read all
      allow read: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        isCommissioner() ||
        isAdmin()
      );
      
      // Parents and commissioners can create grievance chats
      allow create: if isAuthenticated();
      
      // Participants can update (add messages, update status)
      allow update: if isAuthenticated() && (
        resource.data.parentId == request.auth.uid ||
        isCommissioner() ||
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
    }
    
    // =============================================================================
    // INFRACTIONS - Team/player infractions reported by commissioners
    // =============================================================================
    match /infractions/{infractionId} {
      // Commissioners and admin can read infractions
      allow read: if isAuthenticated() && (
        isCommissioner() ||
        isAdmin() ||
        resource.data.reportedBy == request.auth.uid
      );
      
      // Commissioners can create infractions
      allow create: if isAuthenticated() && (isCommissioner() || isAdmin());
      
      // Commissioners and admin can update (change status, add notes)
      allow update: if isAuthenticated() && (isCommissioner() || isAdmin());
      
      // Only admin can delete
      allow delete: if isAdmin();
      
      // Infraction thread messages
      match /messages/{messageId} {
        allow read: if isAuthenticated() && (isCommissioner() || isAdmin());
        allow create: if isAuthenticated() && (isCommissioner() || isAdmin());
        allow update, delete: if isAdmin();
      }
    }
    
    // =============================================================================
    // COMMISSIONER BULLETINS - Announcements from commissioners to their teams
    // =============================================================================
    match /commissionerBulletins/{bulletinId} {
      // Commissioners can read their own bulletins, admin can read all
      allow read: if isAuthenticated() && (
        isCommissioner() || 
        isAdmin()
      );
      
      // Commissioners can create bulletins
      allow create: if isCommissioner();
      
      // Creator or admin can update bulletins
      allow update: if isAuthenticated() && (
        resource.data.creatorId == request.auth.uid ||
        isCommissioner() ||
        isAdmin()
      );
      
      // Creator or admin can delete bulletins
      allow delete: if isAuthenticated() && (
        resource.data.creatorId == request.auth.uid || 
        isCommissioner() ||
        isAdmin()
      );
    }
    
    // =============================================================================
    // PRIVATE CHATS - Direct messaging between users
    // =============================================================================
    match /private_chats/{chatId} {
      // Only participants can read the chat
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // Authenticated users can create private chats
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
      
      // Participants can update (new messages, read status, etc.)
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // Only admin can delete chats
      allow delete: if isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        // Parent doc access check isn't available in subcollection, so use simpler check
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
    }

    // =============================================================================
    // PROGRAMS COLLECTION (Commissioner managed sports programs)
    // =============================================================================
    match /programs/{programId} {
      // Anyone can read programs (for registration pages)
      allow read: if true;
      
      // Only commissioners can create programs
      allow create: if isCommissioner() && request.resource.data.ownerId == request.auth.uid;
      
      // Owner or admin can update
      allow update: if isUser(resource.data.ownerId) || isAdmin();
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // SEASONS COLLECTION (Registration periods for programs)
    // =============================================================================
    match /seasons/{seasonId} {
      // Anyone can read seasons (for registration)
      allow read: if true;
      
      // Program owner or admin can create seasons
      allow create: if isCommissioner() && request.resource.data.ownerId == request.auth.uid;
      
      // Owner or admin can update (includes registration count increments)
      allow update: if isUser(resource.data.ownerId) || isAdmin() || isAuthenticated();
      
      // Only admin can delete
      allow delete: if isAdmin();
      
      // Draft pool subcollection
      match /draftPool/{playerId} {
        // Commissioners and coaches can read draft pool
        allow read: if isCommissioner() || isCoach() || isAdmin();
        
        // System creates entries via registration (authenticated users)
        allow create: if isAuthenticated();
        
        // Commissioners and admins can update (for draft operations)
        allow update: if isCommissioner() || isAdmin();
        
        // Only admin can delete
        allow delete: if isAdmin();
      }
    }
  }
}
