rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isCoach() {
      return isAuthenticated() && getUserData().role == 'Coach';
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'SuperAdmin';
    }
    
    function isTeamCoach(teamId) {
      return isCoach() && (
        getUserData().teamId == teamId ||
        (getUserData().teamIds != null && teamId in getUserData().teamIds)
      );
    }
    
    function isTeamMember(teamId) {
      return isAuthenticated() && (
        getUserData().teamId == teamId || 
        (getUserData().teamIds != null && teamId in getUserData().teamIds)
      );
    }

    // =============================================================================
    // EVENTS COLLECTION
    // =============================================================================
    match /events/{eventId} {
      // Anyone can read public events, team members can read private events
      allow read: if resource.data.isPublic == true || isTeamMember(resource.data.teamId) || isAdmin();
      
      // Only coaches can create events for their teams
      allow create: if isTeamCoach(request.resource.data.teamId) || isAdmin();
      
      // Only coaches of the team can update/delete
      allow update, delete: if isTeamCoach(resource.data.teamId) || isAdmin();

      // =============================================================================
      // PRICING TIERS SUBCOLLECTION (nested under events)
      // =============================================================================
      match /pricingTiers/{tierId} {
        // Anyone can read pricing tiers (needed for registration page)
        allow read: if true;
        
        // Only coaches of the parent event's team can create/update/delete
        allow create: if isTeamCoach(get(/databases/$(database)/documents/events/$(eventId)).data.teamId) || isAdmin();
        allow update, delete: if isTeamCoach(get(/databases/$(database)/documents/events/$(eventId)).data.teamId) || isAdmin();
      }
    }

    // =============================================================================
    // PRICING TIERS COLLECTION (legacy flat collection - keep for migration)
    // =============================================================================
    match /pricingTiers/{tierId} {
      // Anyone can read pricing tiers (needed for registration)
      allow read: if true;
      
      // Only coaches can create/update/delete pricing tiers
      allow create: if isAuthenticated() && (
        isTeamCoach(get(/databases/$(database)/documents/events/$(request.resource.data.eventId)).data.teamId) || 
        isAdmin()
      );
      
      allow update, delete: if isAuthenticated() && (
        isTeamCoach(get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.teamId) || 
        isAdmin()
      );
    }

    // =============================================================================
    // PROMO CODES COLLECTION
    // =============================================================================
    match /promoCodes/{promoId} {
      // Only coaches can read all promo codes for their events
      // Users can validate individual codes through Cloud Functions
      allow read: if isTeamCoach(resource.data.teamId) || isAdmin();
      
      // Only coaches can create/update/delete promo codes
      allow create: if isTeamCoach(request.resource.data.teamId) || isAdmin();
      allow update, delete: if isTeamCoach(resource.data.teamId) || isAdmin();
    }

    // =============================================================================
    // REGISTRATION ORDERS COLLECTION
    // =============================================================================
    match /registrationOrders/{orderId} {
      // Users can read their own orders, coaches can read orders for their events
      allow read: if isUser(resource.data.parentUserId) || 
                     isTeamCoach(resource.data.teamId) || 
                     isAdmin();
      
      // Authenticated users can create registration orders
      allow create: if isAuthenticated() && request.resource.data.parentUserId == request.auth.uid;
      
      // Users can update their pending orders, coaches can update any order
      allow update: if (isUser(resource.data.parentUserId) && resource.data.paymentStatus == 'pending') ||
                       isTeamCoach(resource.data.teamId) || 
                       isAdmin();
      
      // Only admins can delete orders
      allow delete: if isAdmin();
    }

    // =============================================================================
    // REGISTRATIONS COLLECTION
    // =============================================================================
    match /registrations/{registrationId} {
      // Users can read their own registrations, coaches can read registrations for their events
      allow read: if isUser(resource.data.parentUserId) || 
                     isTeamCoach(resource.data.teamId) || 
                     isAdmin();
      
      // Authenticated users can create registrations (linked to their account)
      allow create: if isAuthenticated() && request.resource.data.parentUserId == request.auth.uid;
      
      // Users can update their pending registrations, coaches can update any registration
      allow update: if (isUser(resource.data.parentUserId) && resource.data.status in ['pending_payment', 'waitlisted']) ||
                       isTeamCoach(resource.data.teamId) || 
                       isAdmin();
      
      // Only coaches and admins can delete registrations
      allow delete: if isTeamCoach(resource.data.teamId) || isAdmin();
    }

    // =============================================================================
    // TEAM PAYMENT SETTINGS COLLECTION
    // =============================================================================
    match /teamPaymentSettings/{teamId} {
      // Coaches can read/write their team's payment settings
      allow read, write: if isTeamCoach(teamId) || isAdmin();
    }

    // =============================================================================
    // CONTENT REPORTS COLLECTION (Moderation System)
    // =============================================================================
    match /contentReports/{reportId} {
      // Only admins and team coaches can read reports
      allow read: if isAdmin() || isTeamCoach(resource.data.teamId);
      
      // Any authenticated user can create a report (for their own team's content)
      allow create: if isAuthenticated() && 
                       request.resource.data.reportedBy == request.auth.uid &&
                       request.resource.data.status == 'pending';
      
      // Only admins can update reports (for review process)
      allow update: if isAdmin();
      
      // Only admins can delete reports
      allow delete: if isAdmin();
    }

    // =============================================================================
    // USER FEEDBACK COLLECTION
    // =============================================================================
    match /feedback/{feedbackId} {
      // Only admins can read feedback
      allow read: if isAdmin();
      
      // Any authenticated user can create feedback
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'new';
      
      // Only admins can update/delete feedback
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // FUNDRAISING CAMPAIGNS COLLECTION
    // =============================================================================
    match /campaigns/{campaignId} {
      // Public campaigns can be read by anyone, private by team members
      allow read: if resource.data.isPublic == true || 
                     (resource.data.teamId != null && isTeamMember(resource.data.teamId)) ||
                     isUser(resource.data.createdBy) ||
                     isAdmin();
      
      // Team campaigns: coaches can create
      // Athlete campaigns: athlete's parent can create
      allow create: if isAuthenticated() && (
        (request.resource.data.type == 'team' && isTeamCoach(request.resource.data.teamId)) ||
        (request.resource.data.type == 'athlete' && request.resource.data.createdBy == request.auth.uid) ||
        isAdmin()
      );
      
      // Only campaign creator, team coach, or admin can update
      allow update: if isUser(resource.data.createdBy) || 
                       (resource.data.teamId != null && isTeamCoach(resource.data.teamId)) ||
                       isAdmin();
      
      // Only admin can delete campaigns
      allow delete: if isAdmin();
      
      // Campaign updates subcollection
      match /updates/{updateId} {
        allow read: if true; // Public
        allow create, update, delete: if isUser(get(/databases/$(database)/documents/campaigns/$(campaignId)).data.createdBy) ||
                                         isAdmin();
      }
    }

    // =============================================================================
    // DONATIONS COLLECTION
    // =============================================================================
    match /donations/{donationId} {
      // Campaign owners can read donations, donors can read their own
      allow read: if isUser(resource.data.donorUserId) ||
                     isUser(get(/databases/$(database)/documents/campaigns/$(resource.data.campaignId)).data.createdBy) ||
                     isAdmin();
      
      // Authenticated users can create donations
      allow create: if isAuthenticated();
      
      // Only admins can update/delete (for refund handling)
      allow update, delete: if isAdmin();
    }

    // =============================================================================
    // NIL DEALS COLLECTION
    // =============================================================================
    match /nilDeals/{dealId} {
      // Athlete and their parent can read their deals
      allow read: if isUser(resource.data.athleteId) ||
                     isUser(get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId) ||
                     isAdmin();
      
      // Athlete's parent can create deals
      allow create: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(request.resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Athlete's parent can update deals
      allow update: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // NIL PAYMENTS COLLECTION
    // =============================================================================
    match /nilPayments/{paymentId} {
      // Athlete and their parent can read their payments
      allow read: if isUser(resource.data.athleteId) ||
                     isUser(get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId) ||
                     isAdmin();
      
      // Athlete's parent can create payments
      allow create: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(request.resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Athlete's parent can update payments
      allow update: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/athletes/$(resource.data.athleteId)).data.parentUserId ||
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // =============================================================================
    // EXISTING COLLECTIONS (keep your existing rules here)
    // =============================================================================
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      // Users can update their own profile, but NOT credit-related fields
      // Credit fields can only be updated by SuperAdmin
      allow update: if isUser(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['credits', 'lifetimeCreditsEarned', 'lifetimeCreditsSpent', 'lifetimeCreditsGifted', 'lifetimeCreditsReceived', 'pilotProgramId', 'pilotExpiresAt']);
      allow create: if isUser(userId);
      allow delete: if isAdmin();
      // SuperAdmin can update any field including credits
      allow write: if isAdmin();
      
      // User's plays subcollection (Coach Playbook)
      match /plays/{playId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }
      
      // User's formations subcollection
      match /formations/{formationId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }
      
      // User's imported playbooks
      match /importedPlaybooks/{playbookId} {
        allow read: if isAuthenticated();
        allow write: if isUser(userId) || isAdmin();
      }
      
      // Coach announcements (public profile)
      match /announcements/{announcementId} {
        allow read: if true;
        allow write: if isUser(userId) || isAdmin();
        
        // Announcement comments
        match /comments/{commentId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
      }
      
      // Coach public chat messages
      match /publicChatMessages/{messageId} {
        allow read: if true;
        allow write: if isAuthenticated();
      }
      
      // Coach muted users
      match /mutedUsers/{mutedId} {
        allow read: if isUser(userId);
        allow write: if isUser(userId);
      }
      
      // =============================================================================
      // PROMO ITEMS SUBCOLLECTION - Personal saved designs and player public promos
      // =============================================================================
      match /promoItems/{promoId} {
        // Owner can read all their promo items, public items visible to all
        allow read: if isUser(userId) || 
                       resource.data.isPublic == true || 
                       isAdmin();
        
        // User can create promo items in their own folder
        // Parents can also create promos for their players (playerId field)
        allow create: if isUser(userId) || 
                         (isAuthenticated() && request.resource.data.location == 'player') ||
                         isAdmin();
        
        // Owner or creator can update/delete
        allow update, delete: if isUser(userId) || 
                                 isUser(resource.data.createdBy) ||
                                 isAdmin();
      }
      
      // =============================================================================
      // CREDIT TRANSACTIONS - User's credit history
      // SECURITY: Only SuperAdmin can write transactions directly.
      // All credit operations should go through creditService which runs in trusted context.
      // Cloud Functions with admin SDK bypass these rules entirely.
      // =============================================================================
      match /creditTransactions/{transactionId} {
        // User can read their own transactions, admin can read all
        allow read: if isUser(userId) || isAdmin();
        
        // CRITICAL: Only SuperAdmin can create transactions directly
        // Regular users cannot create credit transactions - prevents self-crediting
        // The creditService validates user context before writing
        allow create: if isAdmin();
        
        // No updates or deletes on transaction history (immutable ledger)
        allow update, delete: if isAdmin();
      }
      
      // =============================================================================
      // USED PROMO CODES - Track which promo codes user has redeemed
      // =============================================================================
      match /usedPromoCodes/{codeId} {
        allow read: if isUser(userId) || isAdmin();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
    }
    
    // Teams collection
    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow write: if isTeamCoach(teamId) || isAdmin();
      
      // Players subcollection
      match /players/{playerId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
        
        // Player's film room
        match /filmRoom/{filmId} {
          allow read: if isAuthenticated();
          allow write: if isTeamCoach(teamId) || isAdmin();
        }
        
        // Player's followers (fans)
        match /followers/{followerId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Player's kudos
        match /kudos/{kudosId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Fan clips
        match /fanClips/{clipId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Public chat messages
        match /publicChatMessages/{messageId} {
          allow read: if true;
          allow write: if isAuthenticated();
        }
        
        // Public chat muted
        match /publicChatMuted/{mutedId} {
          allow read: if isTeamCoach(teamId);
          allow write: if isTeamCoach(teamId);
        }
      }
      
      // Plays subcollection (Team Playbook)
      match /plays/{playId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Assigned plays subcollection
      match /assignedPlays/{assignmentId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
        
        // Position assignments
        match /positionAssignments/{positionId} {
          allow read: if isAuthenticated();
          allow write: if isTeamCoach(teamId) || isAdmin();
        }
      }
      
      // Team events subcollection
      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Team announcements/bulletin
      match /announcements/{announcementId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Coaches subcollection
      match /coaches/{coachId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Player stats subcollection
      match /playerStats/{statId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Live streams subcollection
      match /liveStreams/{streamId} {
        allow read: if true;
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Team chat messages
      match /messages/{messageId} {
        allow read: if isTeamMember(teamId);
        allow write: if isTeamMember(teamId);
      }
      
      // Season stats subcollection
      match /seasonStats/{statId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Games subcollection
      match /games/{gameId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Videos subcollection
      match /videos/{videoId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Strategies subcollection
      match /strategies/{strategyId} {
        allow read: if isTeamMember(teamId);
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // Bulletin subcollection
      match /bulletin/{bulletinId} {
        allow read: if isAuthenticated();
        allow write: if isTeamCoach(teamId) || isAdmin();
      }
      
      // =============================================================================
      // PROMO ITEMS SUBCOLLECTION - Saved flyers and promotional materials
      // =============================================================================
      match /promoItems/{promoId} {
        // Team members can read promo items, public items visible to all
        allow read: if resource.data.isPublic == true || 
                       isTeamMember(teamId) || 
                       isAdmin();
        
        // Only coaches can create promo items for the team
        allow create: if isTeamCoach(teamId) || isAdmin();
        
        // Coaches can update/delete team promo items
        allow update, delete: if isTeamCoach(teamId) || isAdmin();
      }
      
      // =============================================================================
      // SEASONS SUBCOLLECTION - Season management for teams
      // =============================================================================
      match /seasons/{seasonId} {
        // Anyone can read seasons (for public registration pages)
        allow read: if true;
        
        // Only coaches can create/update/delete seasons
        allow create: if isTeamCoach(teamId) || isAdmin();
        allow update: if isTeamCoach(teamId) || isAdmin();
        allow delete: if isTeamCoach(teamId) || isAdmin();
        
        // Season registrations subcollection
        match /registrations/{registrationId} {
          // Coaches can read all registrations, parents can read their own
          allow read: if isTeamCoach(teamId) || 
                         isUser(resource.data.parentId) || 
                         isAdmin();
          
          // Parents can create registrations for their players
          allow create: if isAuthenticated() && 
                           request.resource.data.parentId == request.auth.uid;
          
          // Coaches can update (approve/reject), parents can update pending registrations
          allow update: if isTeamCoach(teamId) || 
                           (isUser(resource.data.parentId) && resource.data.status == 'pending') ||
                           isAdmin();
          
          // Only coaches/admin can delete registrations
          allow delete: if isTeamCoach(teamId) || isAdmin();
        }
      }
    }
    
    // Athletes collection
    match /athletes/{athleteId} {
      allow read: if isAuthenticated();
      allow write: if isTeamCoach(resource.data.teamId) || 
                      isUser(resource.data.parentUserId) || 
                      isAdmin();
    }
    
    // =============================================================================
    // SYSTEM COLLECTIONS (Admin-managed playbooks, plays, formations)
    // =============================================================================
    
    // System Playbooks (published playbook packages)
    match /systemPlaybooks/{playbookId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System Plays (plays within playbook packages)
    match /systemPlays/{playId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System Formations (formations within playbook packages)
    match /systemFormations/{formationId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // =============================================================================
    // SETTINGS & CONFIGURATION
    // =============================================================================
    
    // App Settings (SuperAdmin only write, anyone can read)
    match /appConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Monetization & Credit Settings (SuperAdmin only)
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Payment logs (admin read only)
    match /paymentLogs/{logId} {
      allow read: if isAdmin();
      allow create: if true; // Cloud function creates these
      allow update, delete: if isAdmin();
    }
    
    // =============================================================================
    // ADMIN AUDIT LOG - Security compliance logging
    // =============================================================================
    match /adminAuditLog/{logId} {
      // Only SuperAdmin can read audit logs
      allow read: if isAdmin();
      // Authenticated users can create (service creates on behalf of admin)
      allow create: if isAuthenticated();
      // No updates or deletes - audit log is immutable
      allow update, delete: if false;
    }
  }
}
